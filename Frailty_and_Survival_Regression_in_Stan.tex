% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{5}
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{multirow}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Stan

Program}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Frailty and Survival Regression Models in Stan},
  pdfauthor={Michael Issa},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Frailty and Survival Regression Models in Stan}
\author{Michael Issa}
\date{October 2024}

\begin{document}
\maketitle

\renewcommand*\contentsname{Table of contents}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{3}
\tableofcontents
}
\section{Survival Regression Models}\label{survival-regression-models}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ arviz }\ImportTok{as}\NormalTok{ az}
\ImportTok{import}\NormalTok{ preliz }\ImportTok{as}\NormalTok{ pz}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ warnings}
\ImportTok{import}\NormalTok{ os}

\ImportTok{from}\NormalTok{ cmdstanpy }\ImportTok{import}\NormalTok{ CmdStanModel, from\_csv}

\NormalTok{warnings.filterwarnings(}\StringTok{"ignore"}\NormalTok{)}

\CommentTok{\# Graphic configuration}
\NormalTok{c\_light }\OperatorTok{=} \StringTok{"\#DCBCBC"}
\NormalTok{c\_light\_highlight }\OperatorTok{=} \StringTok{"\#C79999"}
\NormalTok{c\_mid }\OperatorTok{=} \StringTok{"\#B97C7C"}
\NormalTok{c\_mid\_highlight }\OperatorTok{=} \StringTok{"\#A25050"}
\NormalTok{c\_dark }\OperatorTok{=} \StringTok{"\#8F2727"}
\NormalTok{c\_dark\_highlight }\OperatorTok{=} \StringTok{"\#7C0000"}

\NormalTok{c\_light\_teal }\OperatorTok{=} \StringTok{"\#6B8E8E"}
\NormalTok{c\_mid\_teal }\OperatorTok{=} \StringTok{"\#487575"}
\NormalTok{c\_dark\_teal }\OperatorTok{=} \StringTok{"\#1D4F4F"}

\NormalTok{RANDOM\_SEED }\OperatorTok{=} \DecValTok{58583389}
\NormalTok{np.random.seed(RANDOM\_SEED)}
\NormalTok{az.style.use(}\StringTok{"arviz{-}whitegrid"}\NormalTok{)}

\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}font.family\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}serif\textquotesingle{}}

\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}xtick.labelsize\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{12}  
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}ytick.labelsize\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{12}  
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.labelsize\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{12}  
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.titlesize\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{12}   

\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.spines.top\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \VariableTok{False}
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.spines.right\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \VariableTok{False}
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.spines.left\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \VariableTok{True}
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.spines.bottom\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \VariableTok{True}

\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.xmargin\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{0}  
\NormalTok{plt.rcParams[}\StringTok{\textquotesingle{}axes.ymargin\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{0}  

\NormalTok{plt.subplots\_adjust(left}\OperatorTok{=}\FloatTok{0.15}\NormalTok{, bottom}\OperatorTok{=}\FloatTok{0.15}\NormalTok{, right}\OperatorTok{=}\FloatTok{0.9}\NormalTok{, top}\OperatorTok{=}\FloatTok{0.85}\NormalTok{)}

\NormalTok{current\_working\_directory }\OperatorTok{=}\NormalTok{ os.getcwd()}
\NormalTok{p\_dir }\OperatorTok{=}\NormalTok{ os.path.join(os.path.dirname(current\_working\_directory), }\StringTok{"Frailty\_and\_Survival\_Regression\_in\_Stan"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<Figure size 720x480 with 0 Axes>
\end{verbatim}

\section{Exploration of Data}\label{exploration-of-data}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{retention\_df }\OperatorTok{=}\NormalTok{ pd.read\_csv(os.path.join(current\_working\_directory, }\StringTok{\textquotesingle{}data\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}job\_retention.csv\textquotesingle{}}\NormalTok{))}

\NormalTok{retention\_df.info()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<class 'pandas.core.frame.DataFrame'>
RangeIndex: 3770 entries, 0 to 3769
Data columns (total 7 columns):
 #   Column     Non-Null Count  Dtype 
---  ------     --------------  ----- 
 0   gender     3770 non-null   object
 1   field      3770 non-null   object
 2   level      3770 non-null   object
 3   sentiment  3770 non-null   int64 
 4   intention  3770 non-null   int64 
 5   left       3770 non-null   int64 
 6   month      3770 non-null   int64 
dtypes: int64(4), object(3)
memory usage: 206.3+ KB
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dummies }\OperatorTok{=}\NormalTok{ pd.concat(}
\NormalTok{    [}
\NormalTok{        pd.get\_dummies(retention\_df[}\StringTok{"gender"}\NormalTok{], drop\_first}\OperatorTok{=}\VariableTok{True}\NormalTok{),}
\NormalTok{        pd.get\_dummies(retention\_df[}\StringTok{"level"}\NormalTok{], drop\_first}\OperatorTok{=}\VariableTok{True}\NormalTok{),}
\NormalTok{        pd.get\_dummies(retention\_df[}\StringTok{"field"}\NormalTok{], drop\_first}\OperatorTok{=}\VariableTok{True}\NormalTok{),}
\NormalTok{    ],}
\NormalTok{    axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{).rename(\{}\StringTok{"M"}\NormalTok{: }\StringTok{"Male"}\NormalTok{\}, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}

\NormalTok{retention\_df }\OperatorTok{=}\NormalTok{ pd.concat([retention\_df, dummies], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).sort\_values(}\StringTok{"Male"}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{retention\_df.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& gender & field & level & sentiment & intention & left & month & Male &
Low & Medium & Finance & Health & Law & Public/Government &
Sales/Marketing \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & F & Education and Training & Low & 8 & 5 & 0 & 12 & False & True &
False & False & False & False & False & False \\
1 & F & Education and Training & Medium & 8 & 3 & 1 & 11 & False & False
& True & False & False & False & False & False \\
2 & F & Education and Training & Low & 10 & 7 & 1 & 9 & False & True &
False & False & False & False & False & False \\
3 & F & Education and Training & High & 8 & 2 & 0 & 12 & False & False &
False & False & False & False & False & False \\
4 & F & Education and Training & Low & 8 & 8 & 0 & 12 & False & True &
False & False & False & False & False & False \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Stan data}
\NormalTok{stan\_data\_1 }\OperatorTok{=}\NormalTok{ \{}
  \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(retention\_df[}\StringTok{\textquotesingle{}month\textquotesingle{}}\NormalTok{]),}
  \StringTok{\textquotesingle{}durations\textquotesingle{}}\NormalTok{: retention\_df[}\StringTok{\textquotesingle{}month\textquotesingle{}}\NormalTok{],}
  \StringTok{\textquotesingle{}event\_observed\textquotesingle{}}\NormalTok{: retention\_df[}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{],}
\NormalTok{\}}

\CommentTok{\# Fit the model}
\NormalTok{KM\_model\_path }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}kaplan\_meier.stan\textquotesingle{}}\NormalTok{)}
\NormalTok{KM\_model\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}kaplan\_meier.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{KM\_model }\OperatorTok{=}\NormalTok{ CmdStanModel(stan\_file}\OperatorTok{=}\NormalTok{KM\_model\_path)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit model}
\ControlFlowTok{if}\NormalTok{ os.path.exists(KM\_model\_samples):}
\NormalTok{    km\_fit }\OperatorTok{=}\NormalTok{ from\_csv(KM\_model\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    km\_fit }\OperatorTok{=}\NormalTok{ KM\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_1, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1}\NormalTok{, iter\_warmup}\OperatorTok{=}\DecValTok{1}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    km\_fit.save\_csvfiles(KM\_model\_samples)  }
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Model loaded from existing samples.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{km\_results }\OperatorTok{=}\NormalTok{ km\_fit.km\_results}

\NormalTok{times }\OperatorTok{=}\NormalTok{ np.mean(km\_results[:, :, }\DecValTok{0}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{survival\_prob }\OperatorTok{=}\NormalTok{ np.mean(km\_results[:, :, }\DecValTok{1}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
  

\NormalTok{km\_data }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{\textquotesingle{}Time\textquotesingle{}}\NormalTok{: times,}
    \StringTok{\textquotesingle{}Survival Probability\textquotesingle{}}\NormalTok{: survival\_prob,}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.figure(figsize=(10, 6))}

\NormalTok{sns.lineplot(x=\textquotesingle{}Time\textquotesingle{}, y=\textquotesingle{}Survival Probability\textquotesingle{}, data=km\_data, drawstyle=\textquotesingle{}steps{-}post\textquotesingle{}, color=\textquotesingle{}darkred\textquotesingle{}, label=\textquotesingle{}Kaplan{-}Meier Estimate\textquotesingle{})}

\NormalTok{plt.xlabel(\textquotesingle{}Time (Duration)\textquotesingle{})}
\NormalTok{plt.ylabel(\textquotesingle{}Survival Probability\textquotesingle{})}
\NormalTok{plt.title(\textquotesingle{}Kaplan{-}Meier Survival Curve with 95\% Confidence Interval\textquotesingle{})}
\NormalTok{plt.ylim(0, 1)}
\NormalTok{plt.grid(True)}
\NormalTok{plt.legend()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{KM\_model\_path }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}kaplan\_meier.stan\textquotesingle{}}\NormalTok{)}
\NormalTok{KM\_model }\OperatorTok{=}\NormalTok{ CmdStanModel(stan\_file}\OperatorTok{=}\NormalTok{KM\_model\_path)}

\KeywordTok{def}\NormalTok{ fit\_model(data, model, random\_seed):}
   
\NormalTok{    stan\_data }\OperatorTok{=}\NormalTok{ \{}
        \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(data[}\StringTok{"month"}\NormalTok{]),}
        \StringTok{\textquotesingle{}durations\textquotesingle{}}\NormalTok{: data[}\StringTok{"month"}\NormalTok{],}
        \StringTok{\textquotesingle{}event\_observed\textquotesingle{}}\NormalTok{: data[}\StringTok{"left"}\NormalTok{],}
\NormalTok{    \}}
    
    
\NormalTok{    km\_fit }\OperatorTok{=}\NormalTok{ model.sample(data}\OperatorTok{=}\NormalTok{stan\_data, seed}\OperatorTok{=}\NormalTok{random\_seed, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1}\NormalTok{, iter\_warmup}\OperatorTok{=}\DecValTok{1}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
    

\NormalTok{    km\_results }\OperatorTok{=}\NormalTok{ km\_fit.stan\_variable(}\StringTok{\textquotesingle{}km\_results\textquotesingle{}}\NormalTok{)}
\NormalTok{    times }\OperatorTok{=}\NormalTok{ np.mean(km\_results[:, :, }\DecValTok{0}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    survival\_prob }\OperatorTok{=}\NormalTok{ np.mean(km\_results[:, :, }\DecValTok{1}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}

    \ControlFlowTok{return}\NormalTok{ times, survival\_prob}

\NormalTok{datasets }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{\textquotesingle{}kmf\textquotesingle{}}\NormalTok{: retention\_df,  }
    \StringTok{\textquotesingle{}kmf\_hi\textquotesingle{}}\NormalTok{: retention\_df[retention\_df[}\StringTok{"sentiment"}\NormalTok{] }\OperatorTok{==} \DecValTok{10}\NormalTok{],  }
    \StringTok{\textquotesingle{}kmf\_mid\textquotesingle{}}\NormalTok{: retention\_df[retention\_df[}\StringTok{"sentiment"}\NormalTok{] }\OperatorTok{==} \DecValTok{5}\NormalTok{],  }
    \StringTok{\textquotesingle{}kmf\_low\textquotesingle{}}\NormalTok{: retention\_df[retention\_df[}\StringTok{"sentiment"}\NormalTok{] }\OperatorTok{==} \DecValTok{2}\NormalTok{],  }
\NormalTok{\}}

\NormalTok{plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{6}\NormalTok{))}

\NormalTok{all\_times }\OperatorTok{=}\NormalTok{ []}
\NormalTok{all\_survival\_probs }\OperatorTok{=}\NormalTok{ []}
\NormalTok{labels }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ label, data }\KeywordTok{in}\NormalTok{ datasets.items():}
\NormalTok{    times, survival\_prob }\OperatorTok{=}\NormalTok{ fit\_model(data, KM\_model, RANDOM\_SEED)}
\NormalTok{    all\_times.append(times)}
\NormalTok{    all\_survival\_probs.append(survival\_prob)}
\NormalTok{    labels.append(label)}

\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(all\_times)):}
\NormalTok{    sns.lineplot(x}\OperatorTok{=}\NormalTok{all\_times[i], y}\OperatorTok{=}\NormalTok{all\_survival\_probs[i], drawstyle}\OperatorTok{=}\StringTok{\textquotesingle{}steps{-}post\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\NormalTok{labels[i])}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Time (Duration)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Survival Probability\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Kaplan{-}Meier Survival Curves\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylim(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{plt.grid(}\VariableTok{True}\NormalTok{)}
\NormalTok{plt.legend()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
16:01:32 - cmdstanpy - INFO - CmdStan start processing
chain 1 |          | 00:00 Status
chain 2 |          | 00:00 Status

chain 3 |          | 00:00 Status


chain 4 |          | 00:00 Status


chain 4 |█████     | 00:00 Status

chain 3 |█████     | 00:00 Status
chain 2 |█████     | 00:01 Statuschain 1 |█████     | 00:01 Statuschain 1 |██████████| 00:01 Sampling completed

chain 2 |██████████| 00:01 Sampling completedchain 2 |██████████| 00:01 Sampling completed


chain 3 |██████████| 00:01 Sampling completedchain 3 |██████████| 00:01 Sampling completed



chain 4 |██████████| 00:01 Sampling completedchain 4 |██████████| 00:01 Sampling completed
16:01:33 - cmdstanpy - INFO - CmdStan done processing.
16:01:34 - cmdstanpy - INFO - CmdStan start processing
chain 1 |          | 00:00 Status
chain 2 |          | 00:00 Status

chain 3 |          | 00:00 Status


chain 4 |          | 00:00 Statuschain 1 |█████     | 00:00 Status
chain 2 |█████     | 00:00 Status


chain 4 |█████     | 00:01 Status

chain 3 |█████     | 00:01 Statuschain 1 |██████████| 00:01 Sampling completedchain 1 |██████████| 00:01 Sampling completed

chain 2 |██████████| 00:01 Sampling completedchain 2 |██████████| 00:01 Sampling completed
chain 3 |██████████| 00:01 Sampling completed



chain 4 |██████████| 00:01 Sampling completedchain 4 |██████████| 00:01 Sampling completed
16:01:35 - cmdstanpy - INFO - CmdStan done processing.
16:01:35 - cmdstanpy - INFO - CmdStan start processing
chain 1 |          | 00:00 Status
chain 2 |          | 00:00 Status

chain 3 |          | 00:00 Status


chain 4 |          | 00:00 Status

chain 3 |█████     | 00:00 Statuschain 1 |█████     | 00:00 Status


chain 4 |█████     | 00:01 Status
chain 2 |█████     | 00:01 Statuschain 1 |██████████| 00:01 Sampling completedchain 1 |██████████| 00:01 Sampling completed
chain 2 |██████████| 00:01 Sampling completed


chain 3 |██████████| 00:01 Sampling completedchain 3 |██████████| 00:01 Sampling completed



chain 4 |██████████| 00:01 Sampling completedchain 4 |██████████| 00:01 Sampling completed
16:01:37 - cmdstanpy - INFO - CmdStan done processing.
16:01:37 - cmdstanpy - INFO - CmdStan start processing
chain 1 |          | 00:00 Status
chain 2 |          | 00:00 Status

chain 3 |          | 00:00 Status


chain 4 |          | 00:00 Status

chain 3 |█████     | 00:00 Statuschain 1 |█████     | 00:00 Status


chain 4 |█████     | 00:01 Status
chain 2 |█████     | 00:01 Statuschain 1 |██████████| 00:01 Sampling completedchain 1 |██████████| 00:01 Sampling completed
chain 2 |██████████| 00:01 Sampling completed


chain 3 |██████████| 00:01 Sampling completedchain 3 |██████████| 00:01 Sampling completed



chain 4 |██████████| 00:01 Sampling completedchain 4 |██████████| 00:01 Sampling completed
16:01:38 - cmdstanpy - INFO - CmdStan done processing.
\end{verbatim}

\begin{verbatim}
                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                
\end{verbatim}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-8-output-3.pdf}

\section{Data Preperation For Survival
Regression}\label{data-preperation-for-survival-regression}

You could write this in the transfromed data section of the stan code
but it's so much easier to just transform and pass it.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{intervals }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{12}\NormalTok{)}
\NormalTok{n\_employees }\OperatorTok{=}\NormalTok{ retention\_df.shape[}\DecValTok{0}\NormalTok{]}
\NormalTok{n\_intervals }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(intervals)}
\NormalTok{last\_period }\OperatorTok{=}\NormalTok{ np.floor((retention\_df.month }\OperatorTok{{-}} \FloatTok{0.01}\NormalTok{) }\OperatorTok{/} \DecValTok{1}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{employees }\OperatorTok{=}\NormalTok{ np.arange(n\_employees)}
\NormalTok{quit }\OperatorTok{=}\NormalTok{ np.zeros((n\_employees, n\_intervals))}
\NormalTok{quit[employees, last\_period] }\OperatorTok{=}\NormalTok{ retention\_df[}\StringTok{"left"}\NormalTok{]}
\NormalTok{quit }\OperatorTok{=}\NormalTok{ quit.astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{pd.DataFrame(quit)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
2 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
3 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
4 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
3765 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
3766 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\
3767 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
3768 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
3769 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{exposure }\OperatorTok{=}\NormalTok{ np.greater\_equal.outer(retention\_df.month.to\_numpy(), intervals) }\OperatorTok{*} \DecValTok{1}
\NormalTok{exposure[employees, last\_period] }\OperatorTok{=}\NormalTok{ retention\_df.month }\OperatorTok{{-}}\NormalTok{ intervals[last\_period]}
\NormalTok{pd.DataFrame(exposure)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
2 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 0 & 0 \\
3 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
4 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
3765 & 1 & 1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
3766 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 0 & 0 & 0 & 0 \\
3767 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
3768 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
3769 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
\end{longtable}

\section{Fit Basic Cox Model with Fixed
Effects}\label{fit-basic-cox-model-with-fixed-effects}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{preds }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"sentiment"}\NormalTok{,}
    \StringTok{"Male"}\NormalTok{,}
    \StringTok{"Low"}\NormalTok{,}
    \StringTok{"Medium"}\NormalTok{,}
    \StringTok{"Finance"}\NormalTok{,}
    \StringTok{"Health"}\NormalTok{,}
    \StringTok{"Law"}\NormalTok{,}
    \StringTok{"Public/Government"}\NormalTok{,}
    \StringTok{"Sales/Marketing"}\NormalTok{,}
\NormalTok{]}
\NormalTok{preds2 }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"sentiment"}\NormalTok{,}
    \StringTok{"intention"}\NormalTok{,}
    \StringTok{"Male"}\NormalTok{,}
    \StringTok{"Low"}\NormalTok{,}
    \StringTok{"Medium"}\NormalTok{,}
    \StringTok{"Finance"}\NormalTok{,}
    \StringTok{"Health"}\NormalTok{,}
    \StringTok{"Law"}\NormalTok{,}
    \StringTok{"Public/Government"}\NormalTok{,}
    \StringTok{"Sales/Marketing"}\NormalTok{,}
\NormalTok{]}


\NormalTok{stan\_data\_2 }\OperatorTok{=}\NormalTok{ \{}
  \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(retention\_df),}
  \StringTok{\textquotesingle{}P\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(preds),}
  \StringTok{\textquotesingle{}K\textquotesingle{}}\NormalTok{: n\_intervals,}
  \StringTok{\textquotesingle{}X\_data\textquotesingle{}}\NormalTok{: retention\_df[preds].astype(}\BuiltInTok{int}\NormalTok{),}
  \StringTok{\textquotesingle{}quit\textquotesingle{}}\NormalTok{: quit,}
  \StringTok{\textquotesingle{}exposure\textquotesingle{}}\NormalTok{: exposure,}
\NormalTok{\}}

\NormalTok{stan\_data\_3 }\OperatorTok{=}\NormalTok{ \{}
  \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(retention\_df),}
  \StringTok{\textquotesingle{}P\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(preds2),}
  \StringTok{\textquotesingle{}K\textquotesingle{}}\NormalTok{: n\_intervals,}

  \StringTok{\textquotesingle{}X\_data\textquotesingle{}}\NormalTok{: retention\_df[preds2].astype(}\BuiltInTok{int}\NormalTok{),}
  \StringTok{\textquotesingle{}quit\textquotesingle{}}\NormalTok{: quit,}
  \StringTok{\textquotesingle{}exposure\textquotesingle{}}\NormalTok{: exposure,}
\NormalTok{\}}

\CommentTok{\# Cox PH model}
\NormalTok{cox\_model\_path }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}log\_poisson.stan\textquotesingle{}}\NormalTok{)}
\NormalTok{cox\_model\_base\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}log\_poisson\_base.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{cox\_model\_intention\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}log\_poisson\_intentions.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{cox\_model }\OperatorTok{=}\NormalTok{ CmdStanModel(stan\_file}\OperatorTok{=}\NormalTok{cox\_model\_path)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit model}
\ControlFlowTok{if}\NormalTok{ os.path.exists(cox\_model\_base\_samples):}
\NormalTok{    cox\_fit\_base }\OperatorTok{=}\NormalTok{ from\_csv(cox\_model\_base\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    cox\_fit\_base }\OperatorTok{=}\NormalTok{ cox\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_2, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, parallel\_chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1000}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    cox\_fit\_base.save\_csvfiles(cox\_model\_base\_samples)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}

\ControlFlowTok{if}\NormalTok{ os.path.exists(cox\_model\_intention\_samples):}
\NormalTok{    cox\_fit\_intention }\OperatorTok{=}\NormalTok{ from\_csv(cox\_model\_intention\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    cox\_fit\_intention }\OperatorTok{=}\NormalTok{ cox\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_3, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{,parallel\_chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1000}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    cox\_fit\_intention.save\_csvfiles(cox\_model\_intention\_samples)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Model loaded from existing samples.
Model loaded from existing samples.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{base\_idata }\OperatorTok{=}\NormalTok{ az.from\_cmdstanpy(}
\NormalTok{    cox\_fit\_base,}
\NormalTok{    log\_likelihood}\OperatorTok{=}\StringTok{"log\_lik"}\NormalTok{,}
\NormalTok{    dims}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}log\_lik\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}lambda0\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{]\},}
\NormalTok{    coords}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{: preds,  }\CommentTok{\# Predictor names or indices}
        \StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df))),  }\CommentTok{\# Coordinates for individuals}
        \StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(n\_intervals))  }\CommentTok{\# Coordinates for intervals}
\NormalTok{    \}}
\NormalTok{)}

\NormalTok{base\_intention\_idata }\OperatorTok{=}\NormalTok{ az.from\_cmdstanpy(}
\NormalTok{    cox\_fit\_intention,}
\NormalTok{    log\_likelihood}\OperatorTok{=}\StringTok{"log\_lik"}\NormalTok{,}
\NormalTok{    dims}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}log\_lik\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}lambda0\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{]\},}
\NormalTok{    coords}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{: preds2,  }\CommentTok{\# Predictor names or indices}
        \StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df))),  }\CommentTok{\# Coordinates for individuals}
        \StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(n\_intervals))  }\CommentTok{\# Coordinates for intervals}
\NormalTok{    \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{compare }\OperatorTok{=}\NormalTok{ az.compare(\{}\StringTok{"sentiment"}\NormalTok{: base\_idata, }\StringTok{"intention"}\NormalTok{: base\_intention\_idata\}, ic}\OperatorTok{=}\StringTok{"waic"}\NormalTok{)}
\NormalTok{compare}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& rank & elpd\_waic & p\_waic & elpd\_diff & weight & se & dse & warning
& scale \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
intention & 0 & -5585.694107 & 20.953239 & 0.00000 & 0.997046 &
115.941449 & 0.000000 & False & log \\
sentiment & 1 & -5680.578997 & 20.115744 & 94.88489 & 0.002954 &
117.605617 & 14.205166 & False & log \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{az.plot\_compare(compare)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-15-output-1.pdf}

\subsection{Interpreting the Model
Coefficients}\label{interpreting-the-model-coefficients}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    az.summary(base\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"beta"}\NormalTok{])}
\NormalTok{    .reset\_index()[[}\StringTok{"index"}\NormalTok{, }\StringTok{"mean"}\NormalTok{]]}
\NormalTok{    .rename(\{}\StringTok{"mean"}\NormalTok{: }\StringTok{"expected\_hr"}\NormalTok{\}, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\NormalTok{m1 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    az.summary(base\_intention\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"beta"}\NormalTok{])}
\NormalTok{    .reset\_index()[[}\StringTok{"index"}\NormalTok{, }\StringTok{"mean"}\NormalTok{]]}
\NormalTok{    .rename(\{}\StringTok{"mean"}\NormalTok{: }\StringTok{"expected\_intention\_hr"}\NormalTok{\}, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\NormalTok{m }\OperatorTok{=}\NormalTok{ m.merge(m1, left\_on}\OperatorTok{=}\StringTok{"index"}\NormalTok{, right\_on}\OperatorTok{=}\StringTok{"index"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{m[}\StringTok{"exp(expected\_hr)"}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.exp(m[}\StringTok{"expected\_hr"}\NormalTok{])}
\NormalTok{m[}\StringTok{"exp(expected\_intention\_hr)"}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.exp(m[}\StringTok{"expected\_intention\_hr"}\NormalTok{])}
\NormalTok{m}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& index & expected\_hr & expected\_intention\_hr & exp(expected\_hr) &
exp(expected\_intention\_hr) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & beta{[}Finance{]} & 0.205 & 0.232 & 1.227525 & 1.261120 \\
1 & beta{[}Health{]} & 0.248 & 0.235 & 1.281460 & 1.264909 \\
2 & beta{[}Law{]} & 0.094 & 0.071 & 1.098560 & 1.073581 \\
3 & beta{[}Low{]} & 0.136 & 0.154 & 1.145682 & 1.166491 \\
4 & beta{[}Male{]} & -0.039 & 0.015 & 0.961751 & 1.015113 \\
5 & beta{[}Medium{]} & 0.160 & 0.106 & 1.173511 & 1.111822 \\
6 & beta{[}Public/Government{]} & 0.099 & 0.119 & 1.104066 & 1.126370 \\
7 & beta{[}Sales/Marketing{]} & 0.074 & 0.098 & 1.076807 & 1.102963 \\
8 & beta{[}intention{]} & NaN & 0.189 & NaN & 1.208041 \\
9 & beta{[}sentiment{]} & -0.109 & -0.029 & 0.896730 & 0.971416 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\NormalTok{ax.plot(base\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].mean((}\StringTok{"draw"}\NormalTok{, }\StringTok{"chain"}\NormalTok{)), color}\OperatorTok{=}\StringTok{"black"}\NormalTok{)}
\NormalTok{az.plot\_hdi(}
    \BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{),}
\NormalTok{    base\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{],}
\NormalTok{    color}\OperatorTok{=}\NormalTok{ c\_mid,}
\NormalTok{    ax}\OperatorTok{=}\NormalTok{ax,}
\NormalTok{    hdi\_prob}\OperatorTok{=}\FloatTok{0.99}\NormalTok{,}
\NormalTok{    fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"label"}\NormalTok{: }\StringTok{"Baseline Hazard 99\%"}\NormalTok{, }\StringTok{"alpha"}\NormalTok{: }\FloatTok{0.3}\NormalTok{\},}
\NormalTok{    smooth}\OperatorTok{=}\VariableTok{False}\NormalTok{,}
\NormalTok{)}
\NormalTok{az.plot\_hdi(}
    \BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{),}
\NormalTok{    base\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{],}
\NormalTok{    color}\OperatorTok{=}\NormalTok{c\_mid,}
\NormalTok{    ax}\OperatorTok{=}\NormalTok{ax,}
\NormalTok{    hdi\_prob}\OperatorTok{=}\FloatTok{0.50}\NormalTok{,}
\NormalTok{    fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"label"}\NormalTok{: }\StringTok{"Baseline Hazard 50\%"}\NormalTok{, }\StringTok{"alpha"}\NormalTok{: }\FloatTok{0.8}\NormalTok{\},}
\NormalTok{    smooth}\OperatorTok{=}\VariableTok{False}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.legend()}
\NormalTok{ax.set\_xlabel(}\StringTok{"Time"}\NormalTok{)}
\NormalTok{ax.set\_title(}\StringTok{"Expected Baseline Hazard"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Text(0.5, 1.0, 'Expected Baseline Hazard')
\end{verbatim}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-17-output-2.pdf}

\subsection{Predicting Marginal Effects of CoxPH
regression}\label{predicting-marginal-effects-of-coxph-regression}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ cum\_hazard(hazard):}
    \CommentTok{"""Takes arviz.InferenceData object applies}
\CommentTok{    cumulative sum along baseline hazard"""}
    \ControlFlowTok{return}\NormalTok{ hazard.cumsum(dim}\OperatorTok{=}\StringTok{"intervals"}\NormalTok{)}


\KeywordTok{def}\NormalTok{ survival(hazard):}
    \CommentTok{"""Takes arviz.InferenceData object transforms}
\CommentTok{    cumulative hazard into survival function"""}
    \ControlFlowTok{return}\NormalTok{ np.exp(}\OperatorTok{{-}}\NormalTok{cum\_hazard(hazard))}


\KeywordTok{def}\NormalTok{ get\_mean(trace):}
    \CommentTok{"""Takes arviz.InferenceData object marginalises}
\CommentTok{    over the chain and draw"""}
    \ControlFlowTok{return}\NormalTok{ trace.mean((}\StringTok{"draw"}\NormalTok{, }\StringTok{"chain"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ extract\_individual\_hazard(idata, i, retention\_df, intention}\OperatorTok{=}\VariableTok{False}\NormalTok{):}
\NormalTok{    beta }\OperatorTok{=}\NormalTok{ idata.posterior[}\StringTok{"beta"}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{ intention:}
\NormalTok{        intention\_posterior }\OperatorTok{=}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"intention"}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        intention\_posterior }\OperatorTok{=} \DecValTok{0}
\NormalTok{    hazard\_base\_m1 }\OperatorTok{=}\NormalTok{ idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{]}

\NormalTok{    full\_hazard\_idata }\OperatorTok{=}\NormalTok{ hazard\_base\_m1 }\OperatorTok{*}\NormalTok{ np.exp(}
\NormalTok{        beta.sel(preds}\OperatorTok{=}\StringTok{"sentiment"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"sentiment"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ np.where(intention, intention\_posterior }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"intention"}\NormalTok{], }\DecValTok{0}\NormalTok{)}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Male"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Male"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Low"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Low"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Medium"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Medium"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Finance"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Finance"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Health"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Health"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Law"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Law"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Public/Government"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Public/Government"}\NormalTok{]}
        \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Sales/Marketing"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Sales/Marketing"}\NormalTok{]}
\NormalTok{    )}

\NormalTok{    cum\_haz\_idata }\OperatorTok{=}\NormalTok{ cum\_hazard(full\_hazard\_idata)}
\NormalTok{    survival\_idata }\OperatorTok{=}\NormalTok{ survival(full\_hazard\_idata)}
    \ControlFlowTok{return}\NormalTok{ full\_hazard\_idata, cum\_haz\_idata, survival\_idata, hazard\_base\_m1}


\KeywordTok{def}\NormalTok{ plot\_individuals(retention\_df, idata, individuals}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{300}\NormalTok{, }\DecValTok{700}\NormalTok{], intention}\OperatorTok{=}\VariableTok{False}\NormalTok{):}
\NormalTok{    fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{    axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\NormalTok{    colors }\OperatorTok{=}\NormalTok{ [c\_light\_highlight, c\_mid\_highlight, c\_dark\_highlight]}
    \ControlFlowTok{for}\NormalTok{ i, c }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(individuals, colors):}
\NormalTok{        haz\_idata, cum\_haz\_idata, survival\_idata, base\_hazard }\OperatorTok{=}\NormalTok{ extract\_individual\_hazard(}
\NormalTok{            idata, i, retention\_df, intention}
\NormalTok{        )}
\NormalTok{        axs[}\DecValTok{0}\NormalTok{].plot(get\_mean(survival\_idata), label}\OperatorTok{=}\SpecialStringTok{f"individual\_}\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{, color}\OperatorTok{=}\NormalTok{c)}
\NormalTok{        az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), survival\_idata, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{0}\NormalTok{], fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"color"}\NormalTok{: c\})}
\NormalTok{        axs[}\DecValTok{1}\NormalTok{].plot(get\_mean(cum\_haz\_idata), label}\OperatorTok{=}\SpecialStringTok{f"individual\_}\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{, color}\OperatorTok{=}\NormalTok{c)}
\NormalTok{        az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), cum\_haz\_idata, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{1}\NormalTok{], fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"color"}\NormalTok{: c\})}
\NormalTok{        axs[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Individual Survival Functions"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{        axs[}\DecValTok{1}\NormalTok{].set\_title(}\StringTok{"Individual Cumulative Hazard Functions"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{    az.plot\_hdi(}
        \BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{),}
\NormalTok{        survival(base\_hazard),}
\NormalTok{        color}\OperatorTok{=} \StringTok{\textquotesingle{}lightblue\textquotesingle{}}\NormalTok{,}
\NormalTok{        ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{0}\NormalTok{],}
\NormalTok{        fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"label"}\NormalTok{: }\StringTok{"Baseline Survival"}\NormalTok{\},}
\NormalTok{    )}
\NormalTok{    axs[}\DecValTok{0}\NormalTok{].plot(}
\NormalTok{        get\_mean(survival(base\_hazard)),}
\NormalTok{        color}\OperatorTok{=}\StringTok{\textquotesingle{}black\textquotesingle{}}\NormalTok{,}
\NormalTok{        linestyle}\OperatorTok{=}\StringTok{"{-}{-}"}\NormalTok{,}
\NormalTok{        label}\OperatorTok{=}\StringTok{"Expected Baseline Survival"}\NormalTok{,}
\NormalTok{    )}
\NormalTok{    az.plot\_hdi(}
        \BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{),}
\NormalTok{        cum\_hazard(base\_hazard),}
\NormalTok{        color}\OperatorTok{=}\StringTok{\textquotesingle{}lightblue\textquotesingle{}}\NormalTok{,}
\NormalTok{        ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{1}\NormalTok{],}
\NormalTok{        fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"label"}\NormalTok{: }\StringTok{"Baseline Hazard"}\NormalTok{\},}
\NormalTok{    )}
\NormalTok{    axs[}\DecValTok{1}\NormalTok{].plot(}
\NormalTok{        get\_mean(cum\_hazard(base\_hazard)),}
\NormalTok{        color}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{        linestyle}\OperatorTok{=}\StringTok{"{-}{-}"}\NormalTok{,}
\NormalTok{        label}\OperatorTok{=}\StringTok{"Expected Baseline Hazard"}\NormalTok{,}
\NormalTok{    )}
\NormalTok{    axs[}\DecValTok{0}\NormalTok{].legend()}
\NormalTok{    axs[}\DecValTok{0}\NormalTok{].set\_ylabel(}\StringTok{"Probability of Survival"}\NormalTok{)}
\NormalTok{    axs[}\DecValTok{1}\NormalTok{].set\_ylabel(}\StringTok{"Cumulative Hazard Risk"}\NormalTok{)}
\NormalTok{    axs[}\DecValTok{0}\NormalTok{].set\_xlabel(}\StringTok{"Time"}\NormalTok{)}
\NormalTok{    axs[}\DecValTok{1}\NormalTok{].set\_xlabel(}\StringTok{"Time"}\NormalTok{)}
\NormalTok{    axs[}\DecValTok{1}\NormalTok{].legend()}


\CommentTok{\#\#\#\# Next set up test{-}data input to explore the relationship between levels of the variables.}
\NormalTok{test\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.zeros((}\DecValTok{3}\NormalTok{, }\DecValTok{15}\NormalTok{)), columns}\OperatorTok{=}\NormalTok{retention\_df.columns)}
\NormalTok{test\_df[}\StringTok{"sentiment"}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{]}
\NormalTok{test\_df[}\StringTok{"intention"}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{]}
\NormalTok{test\_df[}\StringTok{"Medium"}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\NormalTok{test\_df[}\StringTok{"Finance"}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\NormalTok{test\_df[}\StringTok{"M"}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{]}
\NormalTok{test\_df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllllll@{}}
\toprule\noalign{}
& gender & field & level & sentiment & intention & left & month & Male &
Low & Medium & Finance & Health & Law & Public/Government &
Sales/Marketing & M \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.0 & 0.0 & 0.0 & 1 & 1 & 0.0 & 0.0 & 0.0 & 0.0 & 0 & 0 & 0.0 & 0.0
& 0.0 & 0.0 & 1 \\
1 & 0.0 & 0.0 & 0.0 & 5 & 5 & 0.0 & 0.0 & 0.0 & 0.0 & 0 & 0 & 0.0 & 0.0
& 0.0 & 0.0 & 1 \\
2 & 0.0 & 0.0 & 0.0 & 10 & 10 & 0.0 & 0.0 & 0.0 & 0.0 & 0 & 0 & 0.0 &
0.0 & 0.0 & 0.0 & 1 \\
\end{longtable}

\subsection{The Intention Model}\label{the-intention-model}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plot\_individuals(test\_df, base\_intention\_idata, [}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], intention}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-20-output-1.pdf}

\subsection{The Sentiment Model}\label{the-sentiment-model}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plot\_individuals(test\_df, base\_idata, [}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], intention}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-21-output-1.pdf}

\subsection{Make Predictions for Individual
Characteristics}\label{make-predictions-for-individual-characteristics}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ create\_predictions(retention\_df, idata, intention}\OperatorTok{=}\VariableTok{False}\NormalTok{):}
\NormalTok{    cum\_haz }\OperatorTok{=}\NormalTok{ \{\}}
\NormalTok{    surv }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df)):}
\NormalTok{        haz\_idata, cum\_haz\_idata, survival\_idata, base\_hazard }\OperatorTok{=}\NormalTok{ extract\_individual\_hazard(}
\NormalTok{            idata, i, retention\_df, intention}\OperatorTok{=}\NormalTok{intention}
\NormalTok{        )}
\NormalTok{        cum\_haz[i] }\OperatorTok{=}\NormalTok{ get\_mean(cum\_haz\_idata)}
\NormalTok{        surv[i] }\OperatorTok{=}\NormalTok{ get\_mean(survival\_idata)}
\NormalTok{    cum\_haz }\OperatorTok{=}\NormalTok{ pd.DataFrame(cum\_haz)}
\NormalTok{    surv }\OperatorTok{=}\NormalTok{ pd.DataFrame(surv)}
    \ControlFlowTok{return}\NormalTok{ cum\_haz, surv}


\NormalTok{cum\_haz\_df, surv\_df }\OperatorTok{=}\NormalTok{ create\_predictions(retention\_df, base\_idata, intention}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{surv\_df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 3760 & 3761 & 3762 &
3763 & 3764 & 3765 & 3766 & 3767 & 3768 & 3769 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.994495 & 0.994356 & 0.995572 & 0.995178 & 0.994495 & 0.994566 &
0.994495 & 0.990584 & 0.992469 & 0.992911 & ... & 0.992580 & 0.993314 &
0.988612 & 0.995744 & 0.994998 & 0.992726 & 0.993951 & 0.993345 &
0.993477 & 0.994150 \\
1 & 0.974127 & 0.973489 & 0.979148 & 0.977311 & 0.974127 & 0.974468 &
0.974127 & 0.956045 & 0.964749 & 0.966780 & ... & 0.965269 & 0.968643 &
0.947054 & 0.979950 & 0.976476 & 0.965907 & 0.971605 & 0.968792 &
0.969388 & 0.972513 \\
2 & 0.941523 & 0.940106 & 0.952715 & 0.948615 & 0.941523 & 0.942283 &
0.941523 & 0.901852 & 0.920823 & 0.925299 & ... & 0.921958 & 0.929383 &
0.882494 & 0.954508 & 0.946765 & 0.923365 & 0.935925 & 0.929731 &
0.931029 & 0.937942 \\
3 & 0.911988 & 0.909895 & 0.928617 & 0.922517 & 0.911988 & 0.913119 &
0.911988 & 0.853926 & 0.881514 & 0.888098 & ... & 0.883173 & 0.894082 &
0.826060 & 0.931284 & 0.919773 & 0.885243 & 0.903707 & 0.894606 &
0.896500 & 0.906698 \\
4 & 0.892185 & 0.889654 & 0.912374 & 0.904963 & 0.892185 & 0.893555 &
0.892185 & 0.822409 & 0.855415 & 0.863370 & ... & 0.857409 & 0.870552 &
0.789319 & 0.915617 & 0.901635 & 0.859903 & 0.882165 & 0.871212 &
0.873463 & 0.885783 \\
5 & 0.851931 & 0.848544 & 0.879136 & 0.869128 & 0.851931 & 0.853774 &
0.851931 & 0.759883 & 0.803027 & 0.813582 & ... & 0.805660 & 0.823070 &
0.717343 & 0.883528 & 0.864648 & 0.808959 & 0.838524 & 0.823990 &
0.826933 & 0.843362 \\
6 & 0.821758 & 0.817762 & 0.854019 & 0.842139 & 0.821758 & 0.823940 &
0.821758 & 0.714393 & 0.764354 & 0.776724 & ... & 0.767427 & 0.787798 &
0.665762 & 0.859246 & 0.836840 & 0.771283 & 0.805946 & 0.788926 &
0.792324 & 0.811649 \\
7 & 0.782887 & 0.778156 & 0.821395 & 0.807191 & 0.782887 & 0.785483 &
0.782887 & 0.657538 & 0.715296 & 0.729833 & ... & 0.718893 & 0.742779 &
0.602277 & 0.827665 & 0.800873 & 0.723405 & 0.764157 & 0.744174 &
0.748088 & 0.770903 \\
8 & 0.749550 & 0.744230 & 0.793161 & 0.777055 & 0.749550 & 0.752480 &
0.749550 & 0.610374 & 0.673932 & 0.690171 & ... & 0.677934 & 0.704558 &
0.550488 & 0.800293 & 0.769913 & 0.682957 & 0.728482 & 0.706195 &
0.710478 & 0.736065 \\
9 & 0.731341 & 0.725713 & 0.777637 & 0.760525 & 0.731341 & 0.734447 &
0.731341 & 0.585232 & 0.651620 & 0.668731 & ... & 0.655821 & 0.683829 &
0.523223 & 0.785226 & 0.752949 & 0.661102 & 0.709057 & 0.685607 &
0.690062 & 0.717074 \\
10 & 0.689687 & 0.683408 & 0.741833 & 0.722522 & 0.689687 & 0.693172 &
0.689687 & 0.529426 & 0.601360 & 0.620295 & ... & 0.605979 & 0.636864 &
0.463596 & 0.750433 & 0.714013 & 0.611800 & 0.664818 & 0.638956 &
0.643741 & 0.673766 \\
11 & 0.675569 & 0.669090 & 0.729602 & 0.709580 & 0.675569 & 0.679177 &
0.675569 & 0.511048 & 0.584577 & 0.604068 & ... & 0.589325 & 0.621085 &
0.444242 & 0.738530 & 0.700775 & 0.595302 & 0.649887 & 0.623279 &
0.628155 & 0.659121 \\
\end{longtable}

\subsection{Sample Survival Curves and their Marginal Expected Survival
Trajectory}\label{sample-survival-curves-and-their-marginal-expected-survival-trajectory}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ cm}

\NormalTok{cm\_subsection }\OperatorTok{=}\NormalTok{ np.linspace(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{120}\NormalTok{)}
\NormalTok{colors\_m }\OperatorTok{=}\NormalTok{ [cm.Reds(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ cm\_subsection]}
\NormalTok{colors }\OperatorTok{=}\NormalTok{ [cm.spring(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ cm\_subsection]}


\NormalTok{fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\NormalTok{cum\_haz\_df.plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, color}\OperatorTok{=}\NormalTok{colors, alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{1}\NormalTok{])}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].plot(cum\_haz\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{), color}\OperatorTok{=}\StringTok{"black"}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].set\_title(}
    \StringTok{"Individual Cumulative Hazard }\CharTok{\textbackslash{}n}\StringTok{ \& Marginal Expected Cumulative Hazard"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}
\NormalTok{)}

\NormalTok{surv\_df.plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, color}\OperatorTok{=}\NormalTok{colors\_m, alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{0}\NormalTok{])}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].plot(surv\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{), color}\OperatorTok{=}\StringTok{"black"}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Individual Survival Curves }\CharTok{\textbackslash{}n}\StringTok{  \& Marginal Expected Survival Curve"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].annotate(}
    \SpecialStringTok{f"Expected Attrition by 6 months: }\SpecialCharTok{\{}\DecValTok{100}\OperatorTok{*}\NormalTok{np}\SpecialCharTok{.}\BuiltInTok{round}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{surv\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).iloc[}\DecValTok{6}\NormalTok{], }\DecValTok{2}\NormalTok{)}\SpecialCharTok{\}}\SpecialStringTok{\%"}\NormalTok{,}
\NormalTok{    (}\DecValTok{2}\NormalTok{, }\FloatTok{0.5}\NormalTok{),}
\NormalTok{    fontsize}\OperatorTok{=}\DecValTok{14}\NormalTok{,}
\NormalTok{    fontweight}\OperatorTok{=}\StringTok{"bold"}\NormalTok{,}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Text(2, 0.5, 'Expected Attrition by 6 months: 20.0%')
\end{verbatim}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-23-output-2.pdf}

\section{Accelerated Failure Time
Models}\label{accelerated-failure-time-models}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ scipy.stats }\ImportTok{import}\NormalTok{ fisk, weibull\_min}
\NormalTok{fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{axs }\OperatorTok{=}\NormalTok{ axs.flatten()}


\KeywordTok{def}\NormalTok{ make\_loglog\_haz(alpha, beta):}
    \CommentTok{\#\# This is the Log Logistic distribution}
\NormalTok{    dist }\OperatorTok{=}\NormalTok{ fisk(c}\OperatorTok{=}\NormalTok{alpha, scale}\OperatorTok{=}\NormalTok{beta)}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.log(np.linspace(}\DecValTok{1}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{100}\NormalTok{))  }\CommentTok{\# Time values}
\NormalTok{    pdf\_values }\OperatorTok{=}\NormalTok{ dist.pdf(t)}
\NormalTok{    sf\_values }\OperatorTok{=}\NormalTok{ dist.sf(t)}
\NormalTok{    haz\_values }\OperatorTok{=}\NormalTok{ pdf\_values }\OperatorTok{/}\NormalTok{ sf\_values}
\NormalTok{    axs[}\DecValTok{0}\NormalTok{].plot(t, haz\_values)}
\NormalTok{    axs[}\DecValTok{2}\NormalTok{].plot(t, sf\_values)}


\KeywordTok{def}\NormalTok{ make\_weibull\_haz(alpha, beta):}
\NormalTok{    dist }\OperatorTok{=}\NormalTok{ weibull\_min(c}\OperatorTok{=}\NormalTok{alpha, scale}\OperatorTok{=}\NormalTok{beta)}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.linspace(}\DecValTok{1}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{100}\NormalTok{)  }\CommentTok{\# Time values}
\NormalTok{    pdf\_values }\OperatorTok{=}\NormalTok{ dist.pdf(t)}
\NormalTok{    sf\_values }\OperatorTok{=}\NormalTok{ dist.sf(t)}
\NormalTok{    haz\_values }\OperatorTok{=}\NormalTok{ pdf\_values }\OperatorTok{/}\NormalTok{ sf\_values}
\NormalTok{    axs[}\DecValTok{1}\NormalTok{].plot(t, haz\_values)}
\NormalTok{    axs[}\DecValTok{3}\NormalTok{].plot(t, sf\_values)}


\NormalTok{[make\_loglog\_haz(}\DecValTok{4}\NormalTok{, b) }\ControlFlowTok{for}\NormalTok{ b }\KeywordTok{in}\NormalTok{ np.linspace(}\FloatTok{0.5}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{)]}
\NormalTok{[make\_loglog\_haz(a, }\DecValTok{2}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ a }\KeywordTok{in}\NormalTok{ np.linspace(}\FloatTok{0.2}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{4}\NormalTok{)]}
\NormalTok{[make\_weibull\_haz(}\DecValTok{25}\NormalTok{, b) }\ControlFlowTok{for}\NormalTok{ b }\KeywordTok{in}\NormalTok{ np.linspace(}\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{4}\NormalTok{)]}
\NormalTok{[make\_weibull\_haz(a, }\DecValTok{3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ a }\KeywordTok{in}\NormalTok{ np.linspace(}\DecValTok{2}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{7}\NormalTok{)]}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Log{-}Logistic Hazard Function"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{15}\NormalTok{)}
\NormalTok{axs[}\DecValTok{2}\NormalTok{].set\_title(}\StringTok{"Log{-}Logistic Survival Function"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{15}\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].set\_title(}\StringTok{"Weibull Hazard Function"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{15}\NormalTok{)}
\NormalTok{axs[}\DecValTok{3}\NormalTok{].set\_title(}\StringTok{"Weibull Survival Function"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{15}\NormalTok{)}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-24-output-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coords }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{"intervals"}\NormalTok{: intervals,}
    \StringTok{"preds"}\NormalTok{: [}
        \StringTok{"sentiment"}\NormalTok{,}
        \StringTok{"intention"}\NormalTok{,}
        \StringTok{"Male"}\NormalTok{,}
        \StringTok{"Low"}\NormalTok{,}
        \StringTok{"Medium"}\NormalTok{,}
        \StringTok{"Finance"}\NormalTok{,}
        \StringTok{"Health"}\NormalTok{,}
        \StringTok{"Law"}\NormalTok{,}
        \StringTok{"Public/Government"}\NormalTok{,}
        \StringTok{"Sales/Marketing"}\NormalTok{,}
\NormalTok{    ],}
\NormalTok{\}}

\NormalTok{X }\OperatorTok{=}\NormalTok{ retention\_df[}
\NormalTok{    [}
        \StringTok{"sentiment"}\NormalTok{,}
        \StringTok{"intention"}\NormalTok{,}
        \StringTok{"Male"}\NormalTok{,}
        \StringTok{"Low"}\NormalTok{,}
        \StringTok{"Medium"}\NormalTok{,}
        \StringTok{"Finance"}\NormalTok{,}
        \StringTok{"Health"}\NormalTok{,}
        \StringTok{"Law"}\NormalTok{,}
        \StringTok{"Public/Government"}\NormalTok{,}
        \StringTok{"Sales/Marketing"}\NormalTok{,}
\NormalTok{    ]}
\NormalTok{].copy()}
\NormalTok{y }\OperatorTok{=}\NormalTok{ retention\_df[}\StringTok{"month"}\NormalTok{].values}
\NormalTok{cens }\OperatorTok{=}\NormalTok{ retention\_df.left.values }\OperatorTok{==} \DecValTok{0}

\NormalTok{stan\_data\_4 }\OperatorTok{=}\NormalTok{ \{}
  \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(X),}
  \StringTok{\textquotesingle{}P\textquotesingle{}}\NormalTok{: X.shape[}\DecValTok{1}\NormalTok{],}
  \StringTok{\textquotesingle{}X\_data\textquotesingle{}}\NormalTok{: X,}
  \StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{: y,}
  \StringTok{\textquotesingle{}cens\textquotesingle{}}\NormalTok{: cens,}
  \StringTok{\textquotesingle{}is\_weibull\textquotesingle{}}\NormalTok{: }\DecValTok{1}\NormalTok{,}
\NormalTok{\}}

\NormalTok{stan\_data\_5 }\OperatorTok{=}\NormalTok{ \{}
  \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(X),}
  \StringTok{\textquotesingle{}P\textquotesingle{}}\NormalTok{: X.shape[}\DecValTok{1}\NormalTok{],}
  \StringTok{\textquotesingle{}X\_data\textquotesingle{}}\NormalTok{: X,}
  \StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{: np.log(y),}
  \StringTok{\textquotesingle{}cens\textquotesingle{}}\NormalTok{: cens,}
  \StringTok{\textquotesingle{}is\_weibull\textquotesingle{}}\NormalTok{: }\DecValTok{0}\NormalTok{,}
\NormalTok{\}}

\NormalTok{aft\_path }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}weibull\_log\_log.stan\textquotesingle{}}\NormalTok{)}
\NormalTok{weibull\_model\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}weibull\_sample.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{loglog\_model\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}loglog\_samples.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{aft\_model }\OperatorTok{=}\NormalTok{ CmdStanModel(stan\_file}\OperatorTok{=}\NormalTok{aft\_path)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit model}
\ControlFlowTok{if}\NormalTok{ os.path.exists(weibull\_model\_samples): }
\NormalTok{    weibull\_fit }\OperatorTok{=}\NormalTok{ from\_csv(weibull\_model\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    weibull\_fit }\OperatorTok{=}\NormalTok{ aft\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_4, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, parallel\_chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1000}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    weibull\_fit.save\_csvfiles(weibull\_model\_samples)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}

\ControlFlowTok{if}\NormalTok{ os.path.exists(loglog\_model\_samples):}
\NormalTok{    loglog\_fit }\OperatorTok{=}\NormalTok{ from\_csv(loglog\_model\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    loglog\_fit }\OperatorTok{=}\NormalTok{ aft\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_5, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{,parallel\_chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1000}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    loglog\_fit.save\_csvfiles(loglog\_model\_samples)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Model loaded from existing samples.
Model loaded from existing samples.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weibull\_idata }\OperatorTok{=}\NormalTok{ az.from\_cmdstanpy(}
\NormalTok{    weibull\_fit,}
\NormalTok{    log\_likelihood}\OperatorTok{=}\StringTok{"log\_lik"}\NormalTok{,}
\NormalTok{    dims}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{], \},}
\NormalTok{    coords}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{: preds2,  }\CommentTok{\# Predictor names or indices}
\NormalTok{    \}}
\NormalTok{)}

\NormalTok{loglogistic\_idata }\OperatorTok{=}\NormalTok{ az.from\_cmdstanpy(}
\NormalTok{    loglog\_fit,}
\NormalTok{    log\_likelihood}\OperatorTok{=}\StringTok{"log\_lik"}\NormalTok{,}
\NormalTok{    dims}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{], \},}
\NormalTok{    coords}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{: preds2,  }\CommentTok{\# Predictor names or indices}
\NormalTok{    \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{compare }\OperatorTok{=}\NormalTok{ az.compare(\{}\StringTok{"weibull"}\NormalTok{: weibull\_idata, }\StringTok{"loglogistic"}\NormalTok{: loglogistic\_idata\}, ic}\OperatorTok{=}\StringTok{"waic"}\NormalTok{)}
\NormalTok{compare}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& rank & elpd\_waic & p\_waic & elpd\_diff & weight & se & dse & warning
& scale \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
loglogistic & 0 & -3046.479210 & 12.375341 & 0.000000 & 1.000000e+00 &
44.023723 & 0.000000 & False & log \\
weibull & 1 & -5476.740427 & 12.082975 & 2430.261217 & 1.837419e-13 &
86.326833 & 56.336104 & False & log \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{az.plot\_compare(compare)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-29-output-1.pdf}

\subsection{Deriving Individual Survival Predictions from AFT
models}\label{deriving-individual-survival-predictions-from-aft-models}

\subsection{Weibull}\label{weibull}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\CommentTok{\#\#\#\# Using the fact that we\textquotesingle{}ve already stored expected value for the regression equation}
\NormalTok{reg }\OperatorTok{=}\NormalTok{ az.summary(weibull\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"reg"}\NormalTok{])[}\StringTok{"mean"}\NormalTok{]}
\NormalTok{t }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{1}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{s }\OperatorTok{=}\NormalTok{ az.summary(weibull\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"s"}\NormalTok{])[}\StringTok{"mean"}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].hist(reg, bins}\OperatorTok{=}\DecValTok{30}\NormalTok{, ec}\OperatorTok{=}\StringTok{"black"}\NormalTok{, color}\OperatorTok{=}\NormalTok{c\_mid)}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].set\_title(}
    \StringTok{"Histogram of Acceleration Factors in the individual Weibull fits }\CharTok{\textbackslash{}n}\StringTok{ across our sample"}
\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].plot(}
\NormalTok{    t,}
\NormalTok{    weibull\_min.sf(t, s, scale}\OperatorTok{=}\NormalTok{reg.iloc[}\DecValTok{0}\NormalTok{]),}
\NormalTok{    label}\OperatorTok{=}\VerbatimStringTok{r"Individual 1 {-} $\textbackslash{}beta$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{reg}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{,"} \OperatorTok{+} \VerbatimStringTok{r"$\textbackslash{}alpha$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{s}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].plot(}
\NormalTok{    t,}
\NormalTok{    weibull\_min.sf(t, s, scale}\OperatorTok{=}\NormalTok{reg.iloc[}\DecValTok{1000}\NormalTok{]),}
\NormalTok{    label}\OperatorTok{=}\VerbatimStringTok{r"Individual 1000 {-} $\textbackslash{}beta$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{reg}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{1000}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{,"} \OperatorTok{+} \VerbatimStringTok{r"$\textbackslash{}alpha$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{s}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].set\_title(}\StringTok{"Comparing Impact of Individual Factor }\CharTok{\textbackslash{}n}\StringTok{ on Survival Function"}\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].legend()}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-30-output-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diff }\OperatorTok{=}\NormalTok{ reg.iloc[}\DecValTok{1000}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ reg.iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{pchange }\OperatorTok{=}\NormalTok{ np.}\BuiltInTok{round}\NormalTok{(}\DecValTok{100} \OperatorTok{*}\NormalTok{ (diff }\OperatorTok{/}\NormalTok{ reg.iloc[}\DecValTok{1000}\NormalTok{]), }\DecValTok{2}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}
    \SpecialStringTok{f"In this case we could think of the relative change in acceleration }\CharTok{\textbackslash{}n}\SpecialStringTok{ factor between the individuals as representing a }\SpecialCharTok{\{}\NormalTok{pchange}\SpecialCharTok{\}}\SpecialStringTok{\% increase"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
In this case we could think of the relative change in acceleration 
 factor between the individuals as representing a 19.89% increase
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reg }\OperatorTok{=}\NormalTok{ az.summary(weibull\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"reg"}\NormalTok{])[}\StringTok{"mean"}\NormalTok{]}
\NormalTok{s }\OperatorTok{=}\NormalTok{ az.summary(weibull\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"s"}\NormalTok{])[}\StringTok{"mean"}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\NormalTok{t }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{1}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{weibull\_predicted\_surv }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    [weibull\_min.sf(t, s, scale}\OperatorTok{=}\NormalTok{reg.iloc[i]) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(reg))]}
\NormalTok{).T}

\NormalTok{weibull\_predicted\_surv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 3760 & 3761 & 3762 &
3763 & 3764 & 3765 & 3766 & 3767 & 3768 & 3769 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.992173 & 0.994964 & 0.989363 & 0.996188 & 0.985887 & 0.986597 &
0.993573 & 0.991462 & 0.984744 & 0.988035 & ... & 0.991931 & 0.992837 &
0.976895 & 0.994112 & 0.994936 & 0.992168 & 0.995689 & 0.992586 &
0.992497 & 0.994100 \\
1 & 0.975356 & 0.984094 & 0.966610 & 0.987945 & 0.955868 & 0.958054 &
0.979734 & 0.973139 & 0.952352 & 0.962498 & ... & 0.974600 & 0.977431 &
0.928458 & 0.981423 & 0.984008 & 0.975341 & 0.986376 & 0.976647 &
0.976368 & 0.981385 \\
2 & 0.952132 & 0.968973 & 0.935420 & 0.976440 & 0.915095 & 0.919214 &
0.960550 & 0.947880 & 0.908489 & 0.927613 & ... & 0.950681 & 0.956117 &
0.864224 & 0.963809 & 0.968805 & 0.952102 & 0.973393 & 0.954611 &
0.954074 & 0.963735 \\
3 & 0.923821 & 0.950360 & 0.897770 & 0.962219 & 0.866469 & 0.872778 &
0.937051 & 0.917167 & 0.856388 & 0.885697 & ... & 0.921548 & 0.930076 &
0.790001 & 0.942192 & 0.950095 & 0.923774 & 0.957373 & 0.927709 &
0.926867 & 0.942075 \\
4 & 0.891418 & 0.928804 & 0.855187 & 0.945665 & 0.812278 & 0.820871 &
0.909996 & 0.882119 & 0.798604 & 0.838556 & ... & 0.888239 & 0.900187 &
0.710392 & 0.917247 & 0.928429 & 0.891352 & 0.938764 & 0.896866 &
0.895685 & 0.917083 \\
5 & 0.855759 & 0.904756 & 0.808967 & 0.927085 & 0.754456 & 0.765293 &
0.880018 & 0.843684 & 0.737297 & 0.787721 & ... & 0.851626 & 0.867187 &
0.629150 & 0.889534 & 0.904261 & 0.855674 & 0.917930 & 0.862855 &
0.861316 & 0.889318 \\
6 & 0.817580 & 0.878608 & 0.760245 & 0.906746 & 0.694672 & 0.707601 &
0.847671 & 0.802694 & 0.674312 & 0.734529 & ... & 0.812478 & 0.831725 &
0.549273 & 0.859542 & 0.877986 & 0.817475 & 0.895184 & 0.826356 &
0.824450 & 0.859272 \\
7 & 0.777539 & 0.850712 & 0.710025 & 0.884884 & 0.634356 & 0.649140 &
0.813454 & 0.759894 & 0.611214 & 0.680147 & ... & 0.771483 & 0.794381 &
0.473056 & 0.827711 & 0.849959 & 0.777414 & 0.870810 & 0.787980 &
0.785711 & 0.827386 \\
8 & 0.736232 & 0.821389 & 0.659186 & 0.861714 & 0.574711 & 0.591052 &
0.777822 & 0.715950 & 0.549298 & 0.625585 & ... & 0.729259 & 0.755685 &
0.402149 & 0.794443 & 0.820505 & 0.736089 & 0.845065 & 0.748281 &
0.745660 & 0.794064 \\
9 & 0.694195 & 0.790937 & 0.608495 & 0.837438 & 0.516730 & 0.534290 &
0.741189 & 0.671460 & 0.489610 & 0.571706 & ... & 0.686365 & 0.716113 &
0.337619 & 0.760106 & 0.789923 & 0.694033 & 0.818187 & 0.707758 &
0.704803 & 0.759674 \\
10 & 0.651905 & 0.759630 & 0.558606 & 0.812242 & 0.461198 & 0.479623 &
0.703932 & 0.626950 & 0.432955 & 0.519228 & ... & 0.643294 & 0.676098 &
0.280042 & 0.725038 & 0.758488 & 0.651727 & 0.790398 & 0.666861 &
0.663598 & 0.724555 \\
11 & 0.609789 & 0.727720 & 0.510071 & 0.786299 & 0.408716 & 0.427652 &
0.666394 & 0.582883 & 0.379921 & 0.468734 & ... & 0.600487 & 0.636026 &
0.229581 & 0.689547 & 0.726456 & 0.609597 & 0.761903 & 0.625990 &
0.622452 & 0.689015 \\
\end{longtable}

\subsection{Log Logistic}\label{log-logistic}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reg }\OperatorTok{=}\NormalTok{ az.summary(loglogistic\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"reg"}\NormalTok{])[}\StringTok{"mean"}\NormalTok{]}
\NormalTok{s }\OperatorTok{=}\NormalTok{ az.summary(loglogistic\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"s"}\NormalTok{])[}\StringTok{"mean"}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\NormalTok{temp }\OperatorTok{=}\NormalTok{ retention\_df}
\NormalTok{t }\OperatorTok{=}\NormalTok{ np.log(np.arange(}\DecValTok{1}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\CommentTok{\#\# Transforming to the Log{-}Logistic scale}
\NormalTok{alpha }\OperatorTok{=}\NormalTok{ np.}\BuiltInTok{round}\NormalTok{((}\DecValTok{1} \OperatorTok{/}\NormalTok{ s), }\DecValTok{3}\NormalTok{)}
\NormalTok{beta }\OperatorTok{=}\NormalTok{ np.}\BuiltInTok{round}\NormalTok{(np.exp(reg) }\OperatorTok{**}\NormalTok{ s, }\DecValTok{3}\NormalTok{)}

\NormalTok{fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].hist(reg, bins}\OperatorTok{=}\DecValTok{30}\NormalTok{, ec}\OperatorTok{=}\StringTok{"black"}\NormalTok{, color}\OperatorTok{=}\NormalTok{c\_mid)}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Histogram of beta terms in the individual Log Logistic fits"}\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].plot(}
\NormalTok{    np.exp(t),}
\NormalTok{    fisk.sf(t, c}\OperatorTok{=}\NormalTok{alpha, scale}\OperatorTok{=}\NormalTok{beta.iloc[}\DecValTok{0}\NormalTok{]),}
\NormalTok{    label}\OperatorTok{=}\VerbatimStringTok{r"$\textbackslash{}beta$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{beta}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{,"} \OperatorTok{+} \VerbatimStringTok{r"$\textbackslash{}alpha$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{alpha}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].plot(}
\NormalTok{    np.exp(t),}
\NormalTok{    fisk.sf(t, c}\OperatorTok{=}\NormalTok{alpha, scale}\OperatorTok{=}\NormalTok{beta.iloc[}\DecValTok{1000}\NormalTok{]),}
\NormalTok{    label}\OperatorTok{=}\VerbatimStringTok{r"$\textbackslash{}beta$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{beta}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{1000}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{,"} \OperatorTok{+} \VerbatimStringTok{r"$\textbackslash{}alpha$: "} \OperatorTok{+} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{alpha}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].set\_title(}\StringTok{"Comparing Impact of Individual Factor }\CharTok{\textbackslash{}n}\StringTok{ on Survival Function"}\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].legend()}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-33-output-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{loglogistic\_predicted\_surv }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    [fisk.sf(t, c}\OperatorTok{=}\NormalTok{alpha, scale}\OperatorTok{=}\NormalTok{beta.iloc[i]) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(reg))]}
\NormalTok{).T}
\NormalTok{loglogistic\_predicted\_surv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 3760 & 3761 & 3762 &
3763 & 3764 & 3765 & 3766 & 3767 & 3768 & 3769 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 1.000000 & 1.000000 & 1.000000 & 1.000000 & 1.000000 & 1.000000 &
1.000000 & 1.000000 & 1.000000 & 1.000000 & ... & 1.000000 & 1.000000 &
1.000000 & 1.000000 & 1.000000 & 1.000000 & 1.000000 & 1.000000 &
1.000000 & 1.000000 \\
1 & 0.968448 & 0.976526 & 0.960711 & 0.980638 & 0.952831 & 0.954046 &
0.972428 & 0.966775 & 0.950543 & 0.956147 & ... & 0.967388 & 0.969639 &
0.935689 & 0.973505 & 0.975729 & 0.968075 & 0.978792 & 0.967985 &
0.968872 & 0.973448 \\
2 & 0.926068 & 0.944373 & 0.908916 & 0.953851 & 0.891818 & 0.894430 &
0.935035 & 0.922328 & 0.886923 & 0.898969 & ... & 0.923698 & 0.928741 &
0.855858 & 0.937479 & 0.942549 & 0.925234 & 0.949582 & 0.925032 &
0.927018 & 0.937350 \\
3 & 0.888468 & 0.915230 & 0.863875 & 0.929303 & 0.839813 & 0.843460 &
0.901510 & 0.883066 & 0.833005 & 0.849822 & ... & 0.885042 & 0.892342 &
0.790625 & 0.905088 & 0.912539 & 0.887262 & 0.922946 & 0.886969 &
0.889844 & 0.904898 \\
4 & 0.856282 & 0.889809 & 0.825982 & 0.907676 & 0.796797 & 0.801192 &
0.872548 & 0.849585 & 0.788621 & 0.808882 & ... & 0.852031 & 0.861099 &
0.738513 & 0.877034 & 0.886412 & 0.854784 & 0.899584 & 0.854422 &
0.857992 & 0.876796 \\
5 & 0.828625 & 0.867607 & 0.793898 & 0.888623 & 0.760889 & 0.765833 &
0.847463 & 0.820909 & 0.751719 & 0.774506 & ... & 0.823725 & 0.834190 &
0.696233 & 0.852683 & 0.863630 & 0.826898 & 0.879084 & 0.826479 &
0.830599 & 0.852406 \\
6 & 0.804602 & 0.848046 & 0.766379 & 0.871708 & 0.730459 & 0.735814 &
0.825525 & 0.796070 & 0.720551 & 0.745229 & ... & 0.799181 & 0.810768 &
0.661238 & 0.831346 & 0.843587 & 0.802690 & 0.860947 & 0.802227 &
0.806788 & 0.831037 \\
7 & 0.783496 & 0.830644 & 0.742465 & 0.856558 & 0.704288 & 0.709955 &
0.806134 & 0.774301 & 0.693820 & 0.719941 & ... & 0.777651 & 0.790154 &
0.631733 & 0.812455 & 0.825780 & 0.781433 & 0.844752 & 0.780934 &
0.785855 & 0.812119 \\
8 & 0.764757 & 0.815023 & 0.721438 & 0.842875 & 0.681480 & 0.687391 &
0.788826 & 0.755015 & 0.670583 & 0.697823 & ... & 0.758563 & 0.771824 &
0.606457 & 0.795569 & 0.809812 & 0.762570 & 0.830166 & 0.762041 &
0.767260 & 0.795210 \\
9 & 0.747966 & 0.800886 & 0.702757 & 0.830423 & 0.661377 & 0.667479 &
0.773244 & 0.737767 & 0.650145 & 0.678264 & ... & 0.741479 & 0.755376 &
0.584506 & 0.780345 & 0.795377 & 0.745675 & 0.816926 & 0.745120 &
0.750589 & 0.779967 \\
10 & 0.732798 & 0.788000 & 0.686010 & 0.819017 & 0.643482 & 0.649736 &
0.759107 & 0.722213 & 0.631987 & 0.660804 & ... & 0.726064 & 0.740500 &
0.565219 & 0.766518 & 0.782232 & 0.730418 & 0.804826 & 0.729843 &
0.735523 & 0.766123 \\
11 & 0.718999 & 0.776181 & 0.670880 & 0.808507 & 0.627416 & 0.633791 &
0.746196 & 0.708085 & 0.615712 & 0.645088 & ... & 0.712054 & 0.726950 &
0.548103 & 0.753875 & 0.770185 & 0.716544 & 0.793699 & 0.715951 &
0.721812 & 0.753466 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{ax.plot(}
\NormalTok{    loglogistic\_predicted\_surv.iloc[:, [}\DecValTok{1}\NormalTok{, }\DecValTok{300}\NormalTok{]], label}\OperatorTok{=}\NormalTok{[}\StringTok{"LL{-}Individual 1"}\NormalTok{, }\StringTok{"LL{-}Individual 300"}\NormalTok{]}
\NormalTok{)}
\NormalTok{ax.plot(}
\NormalTok{    loglogistic\_predicted\_surv.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
\NormalTok{    label}\OperatorTok{=}\StringTok{"LL Marginal Survival Curve"}\NormalTok{,}
\NormalTok{    linestyle}\OperatorTok{=}\StringTok{"{-}{-}"}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{    linewidth}\OperatorTok{=}\FloatTok{4.5}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.plot(weibull\_predicted\_surv.iloc[:, [}\DecValTok{1}\NormalTok{, }\DecValTok{300}\NormalTok{]], label}\OperatorTok{=}\NormalTok{[}\StringTok{"W{-}Individual 1"}\NormalTok{, }\StringTok{"W{-}Individual 300"}\NormalTok{])}
\NormalTok{ax.plot(}
\NormalTok{    weibull\_predicted\_surv.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
\NormalTok{    label}\OperatorTok{=}\StringTok{"W Marginal Survival Curve"}\NormalTok{,}
\NormalTok{    linestyle}\OperatorTok{=}\StringTok{"dotted"}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{    linewidth}\OperatorTok{=}\FloatTok{4.5}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.plot(surv\_df.iloc[:, [}\DecValTok{1}\NormalTok{, }\DecValTok{300}\NormalTok{]], label}\OperatorTok{=}\NormalTok{[}\StringTok{"CoxPH{-}Individual 1"}\NormalTok{, }\StringTok{"CoxPH{-}Individual 300"}\NormalTok{])}
\NormalTok{ax.plot(}
\NormalTok{    surv\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
\NormalTok{    label}\OperatorTok{=}\StringTok{"CoxPH Marginal Survival Curve"}\NormalTok{,}
\NormalTok{    linestyle}\OperatorTok{=}\StringTok{"{-}."}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{    linewidth}\OperatorTok{=}\FloatTok{4.5}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.set\_title(}
    \StringTok{"Comparison predicted Individual Survival Curves and }\CharTok{\textbackslash{}n}\StringTok{ Marginal (expected) Survival curve across Sample"}\NormalTok{,}
\NormalTok{    fontsize}\OperatorTok{=}\DecValTok{25}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.set\_xlabel(}\StringTok{"Time in Month"}\NormalTok{)}
\NormalTok{ax.set\_ylabel(}\StringTok{"Probability"}\NormalTok{)}
\NormalTok{ax.legend()}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-35-output-1.pdf}

\section{Fit Model with Shared Frailty terms by
Individual}\label{fit-model-with-shared-frailty-terms-by-individual}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pz.style.use(}\StringTok{\textquotesingle{}preliz{-}doc\textquotesingle{}}\NormalTok{)}
\NormalTok{params }\OperatorTok{=}\NormalTok{ pz.maxent(pz.Gamma(), }\FloatTok{0.80}\NormalTok{, }\FloatTok{1.30}\NormalTok{, }\FloatTok{0.90}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-36-output-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{alpha }\OperatorTok{=}\NormalTok{ params[}\DecValTok{0}\NormalTok{].alpha}
\NormalTok{beta }\OperatorTok{=}\NormalTok{ params[}\DecValTok{0}\NormalTok{].beta}
\NormalTok{params }\OperatorTok{=}\NormalTok{ np.array([alpha, beta])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\NormalTok{ax.hist(}
\NormalTok{    np.random.gamma(alpha, beta, size}\OperatorTok{=}\DecValTok{1000}\NormalTok{),}
\NormalTok{    ec}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\NormalTok{c\_dark,}
\NormalTok{    bins}\OperatorTok{=}\DecValTok{30}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.4}\NormalTok{,}
\NormalTok{)}

\NormalTok{ax.set\_title(}\StringTok{"Draws from Gamma"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-38-output-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{female\_df }\OperatorTok{=}\NormalTok{ retention\_df[retention\_df[}\StringTok{\textquotesingle{}Male\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{0}\NormalTok{]}
\NormalTok{male\_df }\OperatorTok{=}\NormalTok{ retention\_df[retention\_df[}\StringTok{\textquotesingle{}Male\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{]}

\NormalTok{ordered\_df }\OperatorTok{=}\NormalTok{ pd.concat([female\_df, male\_df], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{ordered\_df }\OperatorTok{=}\NormalTok{ ordered\_df.reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\NormalTok{intervals }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{12}\NormalTok{)}
\NormalTok{n\_employees }\OperatorTok{=}\NormalTok{ ordered\_df.shape[}\DecValTok{0}\NormalTok{]}
\NormalTok{n\_intervals }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(intervals)}
\NormalTok{last\_period }\OperatorTok{=}\NormalTok{ np.floor((ordered\_df.month }\OperatorTok{{-}} \FloatTok{0.01}\NormalTok{) }\OperatorTok{/} \DecValTok{1}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{employees }\OperatorTok{=}\NormalTok{ np.arange(n\_employees)}
\NormalTok{quit }\OperatorTok{=}\NormalTok{ np.zeros((n\_employees, n\_intervals))}
\NormalTok{quit[employees, last\_period] }\OperatorTok{=}\NormalTok{ ordered\_df[}\StringTok{"left"}\NormalTok{]}
\NormalTok{quit }\OperatorTok{=}\NormalTok{ quit.astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{quit\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(quit)}

\NormalTok{exposure }\OperatorTok{=}\NormalTok{ np.greater\_equal.outer(ordered\_df.month.to\_numpy(), intervals) }\OperatorTok{*} \DecValTok{1}
\NormalTok{exposure[employees, last\_period] }\OperatorTok{=}\NormalTok{ ordered\_df.month }\OperatorTok{{-}}\NormalTok{ intervals[last\_period]}
\NormalTok{exposure\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(exposure)}


\NormalTok{preds }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"sentiment"}\NormalTok{,}
    \StringTok{"intention"}\NormalTok{,}
    \StringTok{"Low"}\NormalTok{,}
    \StringTok{"Medium"}\NormalTok{,}
    \StringTok{"Finance"}\NormalTok{,}
    \StringTok{"Health"}\NormalTok{,}
    \StringTok{"Law"}\NormalTok{,}
    \StringTok{"Public/Government"}\NormalTok{,}
    \StringTok{"Sales/Marketing"}\NormalTok{,}
\NormalTok{]}
\NormalTok{preds3 }\OperatorTok{=}\NormalTok{ [}\StringTok{"sentiment"}\NormalTok{, }\StringTok{"Low"}\NormalTok{, }\StringTok{"Medium"}\NormalTok{]}

\NormalTok{stan\_data\_6 }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(ordered\_df),}
    \StringTok{\textquotesingle{}N\_f\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(female\_df),}
    \StringTok{\textquotesingle{}N\_m\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(male\_df),}
    \StringTok{\textquotesingle{}P\textquotesingle{}}\NormalTok{: ordered\_df[preds].shape[}\DecValTok{1}\NormalTok{],}
    \StringTok{\textquotesingle{}K\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(intervals),}
    \StringTok{\textquotesingle{}G\textquotesingle{}}\NormalTok{: }\DecValTok{2}\NormalTok{,}
    \StringTok{\textquotesingle{}F\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(ordered\_df),}
    \StringTok{\textquotesingle{}optm\_params\textquotesingle{}}\NormalTok{: params,}
    \StringTok{\textquotesingle{}X\_data\_f\textquotesingle{}}\NormalTok{: female\_df[preds],}
    \StringTok{\textquotesingle{}X\_data\_m\textquotesingle{}}\NormalTok{: male\_df[preds],}
    \StringTok{\textquotesingle{}quit\textquotesingle{}}\NormalTok{: quit,}
    \StringTok{\textquotesingle{}exposure\textquotesingle{}}\NormalTok{: exposure,}
    \StringTok{\textquotesingle{}frailty\_idx\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(ordered\_df) }\OperatorTok{+} \DecValTok{1}\NormalTok{))}
\NormalTok{\}}

\NormalTok{ordered\_df[}\StringTok{\textquotesingle{}field\_idx\textquotesingle{}}\NormalTok{], field\_labels }\OperatorTok{=}\NormalTok{ pd.factorize(ordered\_df[}\StringTok{\textquotesingle{}field\textquotesingle{}}\NormalTok{])}

\NormalTok{stan\_data\_7 }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(ordered\_df),}
    \StringTok{\textquotesingle{}N\_f\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(female\_df),}
    \StringTok{\textquotesingle{}N\_m\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(male\_df),}
    \StringTok{\textquotesingle{}P\textquotesingle{}}\NormalTok{: ordered\_df[preds3].shape[}\DecValTok{1}\NormalTok{],}
    \StringTok{\textquotesingle{}K\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(intervals),}
    \StringTok{\textquotesingle{}G\textquotesingle{}}\NormalTok{: }\DecValTok{2}\NormalTok{,}
    \StringTok{\textquotesingle{}F\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(field\_labels),}
    \StringTok{\textquotesingle{}optm\_params\textquotesingle{}}\NormalTok{: params,}
    \StringTok{\textquotesingle{}X\_data\_f\textquotesingle{}}\NormalTok{: female\_df[preds3],}
    \StringTok{\textquotesingle{}X\_data\_m\textquotesingle{}}\NormalTok{: male\_df[preds3],}
    \StringTok{\textquotesingle{}quit\textquotesingle{}}\NormalTok{: quit,}
    \StringTok{\textquotesingle{}exposure\textquotesingle{}}\NormalTok{: exposure,}
    \StringTok{\textquotesingle{}frailty\_idx\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(ordered\_df[}\StringTok{\textquotesingle{}field\_idx\textquotesingle{}}\NormalTok{] }\OperatorTok{+} \DecValTok{1}\NormalTok{),}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frailty\_path }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}frailty\_log\_poisson.stan\textquotesingle{}}\NormalTok{)}
\NormalTok{frailty\_model\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}frailty\_samples.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{shared\_frailty\_model\_samples }\OperatorTok{=}\NormalTok{ os.path.join(p\_dir, }\StringTok{\textquotesingle{}models\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}shared\_frailty\_samples.csv\textquotesingle{}}\NormalTok{)}
\NormalTok{frailty\_model }\OperatorTok{=}\NormalTok{ CmdStanModel(stan\_file}\OperatorTok{=}\NormalTok{frailty\_path)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit model}
\ControlFlowTok{if}\NormalTok{ os.path.exists(frailty\_model\_samples):}
\NormalTok{    frailty }\OperatorTok{=}\NormalTok{ from\_csv(frailty\_model\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    frailty }\OperatorTok{=}\NormalTok{ frailty\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_6, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, parallel\_chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1000}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    frailty.save\_csvfiles(frailty\_model\_samples)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}

\ControlFlowTok{if}\NormalTok{ os.path.exists(shared\_frailty\_model\_samples):}
\NormalTok{    shared\_frailty }\OperatorTok{=}\NormalTok{ from\_csv(shared\_frailty\_model\_samples, method}\OperatorTok{=}\StringTok{\textquotesingle{}sample\textquotesingle{}}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model loaded from existing samples."}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
\NormalTok{    shared\_frailty }\OperatorTok{=}\NormalTok{ frailty\_model.sample(data}\OperatorTok{=}\NormalTok{stan\_data\_7, seed}\OperatorTok{=}\NormalTok{RANDOM\_SEED, chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, parallel\_chains}\OperatorTok{=}\DecValTok{4}\NormalTok{, iter\_sampling}\OperatorTok{=}\DecValTok{1000}\NormalTok{, show\_console}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    shared\_frailty.save\_csvfiles(shared\_frailty\_model\_samples)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Model run and saved."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Model loaded from existing samples.
Model loaded from existing samples.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frailty\_idata }\OperatorTok{=}\NormalTok{ az.from\_cmdstanpy(}
\NormalTok{    frailty,}
\NormalTok{    log\_likelihood}\OperatorTok{=}\StringTok{"log\_lik"}\NormalTok{,}
\NormalTok{    dims}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{], }
        \StringTok{\textquotesingle{}log\_lik\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{], }
        \StringTok{\textquotesingle{}lambda0\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}genders\textquotesingle{}}\NormalTok{],  }\CommentTok{\# Consistent naming as \textquotesingle{}genders\textquotesingle{}}
        \StringTok{\textquotesingle{}frailty\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}F\textquotesingle{}}\NormalTok{]}
\NormalTok{    \},}
\NormalTok{    coords}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{: preds, }
        \StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df))),  }
        \StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(n\_intervals)),  }
        \StringTok{\textquotesingle{}genders\textquotesingle{}}\NormalTok{: [}\StringTok{"Male"}\NormalTok{, }\StringTok{"Female"}\NormalTok{],  }\CommentTok{\# Rename \textquotesingle{}G\textquotesingle{} to \textquotesingle{}genders\textquotesingle{}}
        \StringTok{\textquotesingle{}F\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df))),}
\NormalTok{    \},}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shared\_frailty\_idata }\OperatorTok{=}\NormalTok{ az.from\_cmdstanpy(}
\NormalTok{    shared\_frailty,}
\NormalTok{    log\_likelihood}\OperatorTok{=}\StringTok{\textquotesingle{}log\_lik\textquotesingle{}}\NormalTok{,}
\NormalTok{    dims}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{], }
        \StringTok{\textquotesingle{}log\_lik\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{], }
        \StringTok{\textquotesingle{}lambda0\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}genders\textquotesingle{}}\NormalTok{],  }\CommentTok{\# Consistent naming as \textquotesingle{}genders\textquotesingle{}}
        \StringTok{\textquotesingle{}frailty\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}F\textquotesingle{}}\NormalTok{]}
\NormalTok{    \},}
\NormalTok{    coords}\OperatorTok{=}\NormalTok{\{}
        \StringTok{\textquotesingle{}preds\textquotesingle{}}\NormalTok{: preds3,  }
        \StringTok{\textquotesingle{}individuals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df))), }
        \StringTok{\textquotesingle{}intervals\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(n\_intervals)),  }
        \StringTok{\textquotesingle{}genders\textquotesingle{}}\NormalTok{: [}\StringTok{"Male"}\NormalTok{, }\StringTok{"Female"}\NormalTok{],  }\CommentTok{\# Rename \textquotesingle{}G\textquotesingle{} to \textquotesingle{}genders\textquotesingle{}}
        \StringTok{\textquotesingle{}F\textquotesingle{}}\NormalTok{: }\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(field\_labels))),  }\CommentTok{\# Matches field label length}
\NormalTok{    \},}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\NormalTok{base\_m }\OperatorTok{=}\NormalTok{ shared\_frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].sel(genders}\OperatorTok{=}\StringTok{"Male"}\NormalTok{)}
\NormalTok{base\_f }\OperatorTok{=}\NormalTok{ shared\_frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].sel(genders}\OperatorTok{=}\StringTok{"Female"}\NormalTok{)}
\NormalTok{az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), base\_m, ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"lightblue"}\NormalTok{, fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"alpha"}\NormalTok{: }\FloatTok{0.5}\NormalTok{\}, smooth}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), base\_f, ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"red"}\NormalTok{, fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"alpha"}\NormalTok{: }\FloatTok{0.3}\NormalTok{\}, smooth}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{get\_mean(base\_m).plot(ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"darkred"}\NormalTok{, label}\OperatorTok{=}\StringTok{"Male Baseline Hazard Shared Frailty"}\NormalTok{)}
\NormalTok{get\_mean(base\_f).plot(ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"blue"}\NormalTok{, label}\OperatorTok{=}\StringTok{"Female Baseline Hazard Shared Frailty"}\NormalTok{)}

\NormalTok{base\_m\_i }\OperatorTok{=}\NormalTok{ frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].sel(genders}\OperatorTok{=}\StringTok{"Male"}\NormalTok{)}
\NormalTok{base\_f\_i }\OperatorTok{=}\NormalTok{ frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].sel(genders}\OperatorTok{=}\StringTok{"Female"}\NormalTok{)}
\NormalTok{az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), base\_m\_i, ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"cyan"}\NormalTok{, fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"alpha"}\NormalTok{: }\FloatTok{0.5}\NormalTok{\}, smooth}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), base\_f\_i, ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"magenta"}\NormalTok{, fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"alpha"}\NormalTok{: }\FloatTok{0.3}\NormalTok{\}, smooth}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{get\_mean(base\_m\_i).plot(ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"cyan"}\NormalTok{, label}\OperatorTok{=}\StringTok{"Male Baseline Hazard Individual Frailty"}\NormalTok{)}
\NormalTok{get\_mean(base\_f\_i).plot(ax}\OperatorTok{=}\NormalTok{ax, color}\OperatorTok{=}\StringTok{"magenta"}\NormalTok{, label}\OperatorTok{=}\StringTok{"Female Baseline Hazard Individual Frailty"}\NormalTok{)}


\NormalTok{ax.legend()}
\NormalTok{ax.set\_title(}\StringTok{"Stratified Baseline Hazards"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Text(0.5, 1.0, 'Stratified Baseline Hazards')
\end{verbatim}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-44-output-2.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frailty\_terms }\OperatorTok{=}\NormalTok{ az.summary(frailty\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"frailty"}\NormalTok{])}
\NormalTok{frailty\_terms.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& mean & sd & hdi\_3\% & hdi\_97\% & mcse\_mean & mcse\_sd & ess\_bulk &
ess\_tail & r\_hat \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
frailty{[}0{]} & 0.903 & 0.125 & 0.681 & 1.150 & 0.002 & 0.002 & 3474.0
& 2917.0 & 1.0 \\
frailty{[}1{]} & 0.924 & 0.134 & 0.675 & 1.171 & 0.003 & 0.002 & 2081.0
& 2209.0 & 1.0 \\
frailty{[}2{]} & 0.919 & 0.128 & 0.671 & 1.155 & 0.002 & 0.001 & 3880.0
& 2664.0 & 1.0 \\
frailty{[}3{]} & 0.907 & 0.128 & 0.675 & 1.144 & 0.002 & 0.001 & 3930.0
& 2546.0 & 1.0 \\
frailty{[}4{]} & 0.896 & 0.127 & 0.673 & 1.143 & 0.002 & 0.002 & 3246.0
& 1913.0 & 1.0 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{axs }\OperatorTok{=}\NormalTok{ az.plot\_posterior(shared\_frailty\_idata, var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"frailty"}\NormalTok{])}
\NormalTok{axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\ControlFlowTok{for}\NormalTok{ ax, label }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(axs, field\_labels):}
\NormalTok{    ax.set\_title(label) }
\NormalTok{    ax.axvline(}\DecValTok{1}\NormalTok{, color}\OperatorTok{=}\StringTok{"red"}\NormalTok{, label}\OperatorTok{=}\StringTok{"No change"}\NormalTok{)}
\NormalTok{    ax.legend()}

\NormalTok{plt.suptitle(}\StringTok{"Shared Frailty Estimates across the Job Area"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Text(0.5, 0.98, 'Shared Frailty Estimates across the Job Area')
\end{verbatim}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-46-output-2.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ax }\OperatorTok{=}\NormalTok{ az.plot\_forest(}
\NormalTok{    [base\_idata, base\_intention\_idata, weibull\_idata, frailty\_idata],}
\NormalTok{    model\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"coxph\_sentiment"}\NormalTok{, }\StringTok{"coxph\_intention"}\NormalTok{, }\StringTok{"weibull\_sentiment"}\NormalTok{, }\StringTok{"frailty\_intention"}\NormalTok{],}
\NormalTok{    var\_names}\OperatorTok{=}\NormalTok{[}\StringTok{"beta"}\NormalTok{],}
\NormalTok{    combined}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{    figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{15}\NormalTok{),}
\NormalTok{    r\_hat}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{)}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Parameter Estimates: Various Models"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Text(0.5, 1.0, 'Parameter Estimates: Various Models')
\end{verbatim}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-47-output-2.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{temp }\OperatorTok{=}\NormalTok{ retention\_df.copy()}
\NormalTok{temp[}\StringTok{"frailty"}\NormalTok{] }\OperatorTok{=}\NormalTok{ frailty\_terms.reset\_index()[}\StringTok{"mean"}\NormalTok{]}
\NormalTok{(}
\NormalTok{    temp.groupby([}\StringTok{"Male"}\NormalTok{, }\StringTok{"sentiment"}\NormalTok{, }\StringTok{"intention"}\NormalTok{])[[}\StringTok{"frailty"}\NormalTok{]]}
\NormalTok{    .mean()}
\NormalTok{    .reset\_index()}
\NormalTok{    .pivot(index}\OperatorTok{=}\NormalTok{[}\StringTok{"Male"}\NormalTok{, }\StringTok{"sentiment"}\NormalTok{], columns}\OperatorTok{=}\StringTok{"intention"}\NormalTok{, values}\OperatorTok{=}\StringTok{"frailty"}\NormalTok{)}
\NormalTok{    .style.background\_gradient(cmap}\OperatorTok{=}\StringTok{"OrRd"}\NormalTok{, axis}\OperatorTok{=}\VariableTok{None}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{format}\NormalTok{(precision}\OperatorTok{=}\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllll@{}}
\caption{}\label{T_ff72d}\tabularnewline
\toprule\noalign{}
~ & intention & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
Male & sentiment & ~ & ~ & ~ & ~ & ~ & ~ & ~ & ~ & ~ & ~ \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
~ & intention & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
Male & sentiment & ~ & ~ & ~ & ~ & ~ & ~ & ~ & ~ & ~ & ~ \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{10}{=}{False} & 1 & nan & 0.923 & nan & nan & nan & 0.919 &
nan & 0.924 & 0.904 & 0.919 \\
& 2 & 0.903 & nan & nan & 0.908 & 0.914 & 0.903 & 0.905 & 0.915 & 0.924
& 0.903 \\
& 3 & 0.927 & 0.913 & 0.911 & 0.912 & 0.909 & 0.901 & 0.908 & 0.913 &
nan & 0.925 \\
& 4 & 0.916 & 0.909 & 0.924 & 0.910 & 0.915 & 0.910 & 0.910 & 0.906 &
0.915 & nan \\
& 5 & nan & 0.905 & 0.921 & 0.915 & 0.907 & 0.905 & 0.915 & 0.903 & nan
& 0.886 \\
& 6 & 0.915 & 0.910 & 0.905 & 0.908 & 0.917 & 0.908 & 0.903 & 0.917 &
nan & 0.922 \\
& 7 & 0.911 & 0.910 & 0.909 & 0.913 & 0.910 & 0.912 & 0.910 & 0.909 &
0.908 & 0.907 \\
& 8 & 0.909 & 0.910 & 0.910 & 0.909 & 0.909 & 0.910 & 0.909 & 0.909 &
0.908 & 0.901 \\
& 9 & 0.911 & 0.911 & 0.909 & 0.908 & 0.908 & 0.911 & 0.911 & 0.896 &
nan & nan \\
& 10 & 0.907 & 0.911 & 0.909 & 0.910 & 0.910 & 0.911 & 0.914 & 0.895 &
0.901 & nan \\
\multirow{10}{=}{True} & 1 & nan & nan & 0.913 & nan & 0.912 & 0.919 &
0.895 & 0.909 & 0.905 & 0.916 \\
& 2 & nan & 0.911 & 0.913 & 0.908 & 0.905 & 0.911 & 0.907 & 0.907 &
0.909 & 0.919 \\
& 3 & 0.905 & nan & 0.927 & 0.909 & 0.907 & 0.910 & 0.898 & 0.909 &
0.905 & 0.923 \\
& 4 & nan & 0.911 & 0.908 & 0.914 & 0.911 & 0.911 & 0.910 & 0.915 &
0.910 & nan \\
& 5 & 0.905 & 0.914 & 0.909 & 0.908 & 0.917 & 0.914 & 0.904 & 0.912 &
0.893 & 0.888 \\
& 6 & 0.913 & 0.910 & 0.906 & 0.910 & 0.910 & 0.903 & 0.908 & 0.906 &
0.920 & 0.914 \\
& 7 & 0.909 & 0.912 & 0.909 & 0.909 & 0.909 & 0.911 & 0.912 & 0.906 &
0.911 & 0.915 \\
& 8 & 0.910 & 0.910 & 0.909 & 0.910 & 0.911 & 0.912 & 0.911 & 0.913 &
0.915 & 0.917 \\
& 9 & 0.911 & 0.911 & 0.909 & 0.910 & 0.911 & 0.906 & 0.906 & 0.913 &
0.914 & nan \\
& 10 & 0.909 & 0.911 & 0.910 & 0.912 & 0.909 & 0.908 & 0.912 & 0.916 &
0.923 & nan \\
\end{longtable}

\section{Interrogating the Cox Frailty
Model}\label{interrogating-the-cox-frailty-model}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ extract\_individual\_frailty(i, retention\_df, intention}\OperatorTok{=}\VariableTok{False}\NormalTok{):}
\NormalTok{    beta }\OperatorTok{=}\NormalTok{ frailty\_idata.posterior[}\StringTok{"beta"}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{ intention:}
\NormalTok{        intention\_posterior }\OperatorTok{=}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"intention"}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        intention\_posterior }\OperatorTok{=} \DecValTok{0}
\NormalTok{    hazard\_base\_m }\OperatorTok{=}\NormalTok{ frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].sel(genders}\OperatorTok{=}\StringTok{"Male"}\NormalTok{)}
\NormalTok{    hazard\_base\_f }\OperatorTok{=}\NormalTok{ frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"lambda0"}\NormalTok{].sel(genders}\OperatorTok{=}\StringTok{"Female"}\NormalTok{)}
\NormalTok{    frailty }\OperatorTok{=}\NormalTok{ frailty\_idata.posterior[}\StringTok{"frailty"}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Male"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{:}
\NormalTok{        hazard\_base }\OperatorTok{=}\NormalTok{ hazard\_base\_m}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        hazard\_base }\OperatorTok{=}\NormalTok{ hazard\_base\_f}

\NormalTok{    full\_hazard\_idata }\OperatorTok{=}\NormalTok{ hazard\_base }\OperatorTok{*}\NormalTok{ (}
\NormalTok{        frailty.sel(F}\OperatorTok{=}\NormalTok{i).mean().item()}
        \OperatorTok{*}\NormalTok{ np.exp(}
\NormalTok{            beta.sel(preds}\OperatorTok{=}\StringTok{"sentiment"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"sentiment"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ np.where(intention, intention\_posterior }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"intention"}\NormalTok{], }\DecValTok{0}\NormalTok{)}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Low"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Low"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Medium"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Medium"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Finance"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Finance"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Health"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Health"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Law"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Law"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Public/Government"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Public/Government"}\NormalTok{]}
            \OperatorTok{+}\NormalTok{ beta.sel(preds}\OperatorTok{=}\StringTok{"Sales/Marketing"}\NormalTok{) }\OperatorTok{*}\NormalTok{ retention\_df.iloc[i][}\StringTok{"Sales/Marketing"}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}

\NormalTok{    cum\_haz\_idata }\OperatorTok{=}\NormalTok{ cum\_hazard(full\_hazard\_idata)}
\NormalTok{    survival\_idata }\OperatorTok{=}\NormalTok{ survival(full\_hazard\_idata)}
    \ControlFlowTok{return}\NormalTok{ full\_hazard\_idata, cum\_haz\_idata, survival\_idata, hazard\_base}


\KeywordTok{def}\NormalTok{ plot\_individual\_frailty(retention\_df, individuals}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{300}\NormalTok{, }\DecValTok{700}\NormalTok{], intention}\OperatorTok{=}\VariableTok{False}\NormalTok{):}
\NormalTok{    fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{    axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\NormalTok{    colors }\OperatorTok{=}\NormalTok{ [c\_light\_highlight, c\_mid\_highlight, c\_dark\_highlight]}
    \ControlFlowTok{for}\NormalTok{ i, c }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(individuals, colors):}
\NormalTok{        haz\_idata, cum\_haz\_idata, survival\_idata, base\_hazard }\OperatorTok{=}\NormalTok{ extract\_individual\_frailty(}
\NormalTok{            i, retention\_df, intention}
\NormalTok{        )}
\NormalTok{        axs[}\DecValTok{0}\NormalTok{].plot(get\_mean(survival\_idata), label}\OperatorTok{=}\SpecialStringTok{f"individual\_}\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{, color}\OperatorTok{=}\NormalTok{c)}
\NormalTok{        az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), survival\_idata, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{0}\NormalTok{], fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"color"}\NormalTok{: c\})}
\NormalTok{        axs[}\DecValTok{1}\NormalTok{].plot(get\_mean(cum\_haz\_idata), label}\OperatorTok{=}\SpecialStringTok{f"individual\_}\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{, color}\OperatorTok{=}\NormalTok{c)}
\NormalTok{        az.plot\_hdi(}\BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{), cum\_haz\_idata, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{1}\NormalTok{], fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"color"}\NormalTok{: c\})}
\NormalTok{        axs[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Individual Survival Functions"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{        axs[}\DecValTok{1}\NormalTok{].set\_title(}\StringTok{"Individual Cumulative Hazard Functions"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{    az.plot\_hdi(}
        \BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{),}
\NormalTok{        survival(base\_hazard),}
\NormalTok{        color}\OperatorTok{=}\StringTok{"lightblue"}\NormalTok{,}
\NormalTok{        ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{0}\NormalTok{],}
\NormalTok{        fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"label"}\NormalTok{: }\StringTok{"Baseline Survival"}\NormalTok{\},}
\NormalTok{    )}
\NormalTok{    az.plot\_hdi(}
        \BuiltInTok{range}\NormalTok{(}\DecValTok{12}\NormalTok{),}
\NormalTok{        cum\_hazard(base\_hazard),}
\NormalTok{        color}\OperatorTok{=}\StringTok{"lightblue"}\NormalTok{,}
\NormalTok{        ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{1}\NormalTok{],}
\NormalTok{        fill\_kwargs}\OperatorTok{=}\NormalTok{\{}\StringTok{"label"}\NormalTok{: }\StringTok{"Baseline Hazard"}\NormalTok{\},}
\NormalTok{    )}
\NormalTok{    axs[}\DecValTok{0}\NormalTok{].legend()}
\NormalTok{    axs[}\DecValTok{1}\NormalTok{].legend()}


\NormalTok{plot\_individual\_frailty(retention\_df, [}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], intention}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-49-output-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{retention\_df.iloc[}\DecValTok{0}\NormalTok{:}\DecValTok{3}\NormalTok{, :]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& gender & field & level & sentiment & intention & left & month & Male &
Low & Medium & Finance & Health & Law & Public/Government &
Sales/Marketing \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & F & Education and Training & Low & 8 & 5 & 0 & 12 & False & True &
False & False & False & False & False & False \\
1 & F & Education and Training & Medium & 8 & 3 & 1 & 11 & False & False
& True & False & False & False & False & False \\
2 & F & Education and Training & Low & 10 & 7 & 1 & 9 & False & True &
False & False & False & False & False & False \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ create\_predictions(retention\_df, intention}\OperatorTok{=}\VariableTok{False}\NormalTok{):}
\NormalTok{    cum\_haz }\OperatorTok{=}\NormalTok{ \{\}}
\NormalTok{    surv }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(retention\_df)):}
\NormalTok{        haz\_idata, cum\_haz\_idata, survival\_idata, base\_hazard }\OperatorTok{=}\NormalTok{ extract\_individual\_frailty(}
\NormalTok{            i, retention\_df, intention}
\NormalTok{        )}
\NormalTok{        cum\_haz[i] }\OperatorTok{=}\NormalTok{ get\_mean(cum\_haz\_idata)}
\NormalTok{        surv[i] }\OperatorTok{=}\NormalTok{ get\_mean(survival\_idata)}
\NormalTok{    cum\_haz }\OperatorTok{=}\NormalTok{ pd.DataFrame(cum\_haz)}
\NormalTok{    surv }\OperatorTok{=}\NormalTok{ pd.DataFrame(surv)}
    \ControlFlowTok{return}\NormalTok{ cum\_haz, surv}


\NormalTok{cum\_haz\_frailty\_df, surv\_frailty\_df }\OperatorTok{=}\NormalTok{ create\_predictions(retention\_df, intention}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{surv\_frailty\_df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 3760 & 3761 & 3762 &
3763 & 3764 & 3765 & 3766 & 3767 & 3768 & 3769 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.994556 & 0.996365 & 0.992358 & 0.997342 & 0.990454 & 0.990598 &
0.995474 & 0.994158 & 0.989497 & 0.991432 & ... & 0.993611 & 0.994159 &
0.983887 & 0.995008 & 0.995923 & 0.993655 & 0.996453 & 0.994163 &
0.994010 & 0.995178 \\
1 & 0.976164 & 0.984034 & 0.966659 & 0.988308 & 0.958499 & 0.959124 &
0.980155 & 0.974456 & 0.954441 & 0.962691 & ... & 0.969291 & 0.971885 &
0.924029 & 0.975934 & 0.980312 & 0.969488 & 0.982856 & 0.971903 &
0.971174 & 0.976744 \\
2 & 0.941784 & 0.960767 & 0.919169 & 0.971172 & 0.900008 & 0.901449 &
0.951381 & 0.937699 & 0.890533 & 0.909794 & ... & 0.932866 & 0.938441 &
0.838608 & 0.947155 & 0.956668 & 0.933272 & 0.962203 & 0.938494 &
0.936891 & 0.948910 \\
3 & 0.907167 & 0.937054 & 0.872055 & 0.953601 & 0.842719 & 0.844917 &
0.922231 & 0.900797 & 0.828350 & 0.857739 & ... & 0.900901 & 0.908998 &
0.767787 & 0.921692 & 0.935642 & 0.901480 & 0.943779 & 0.909089 &
0.906735 & 0.924260 \\
4 & 0.883206 & 0.920473 & 0.839871 & 0.941238 & 0.804025 & 0.806696 &
0.901944 & 0.875320 & 0.786576 & 0.822396 & ... & 0.879415 & 0.889155 &
0.722349 & 0.904466 & 0.921357 & 0.880107 & 0.931230 & 0.889288 &
0.886427 & 0.907568 \\
5 & 0.841317 & 0.891119 & 0.784477 & 0.919207 & 0.738289 & 0.741728 &
0.866252 & 0.830905 & 0.716087 & 0.761937 & ... & 0.832586 & 0.845780 &
0.629127 & 0.866602 & 0.889792 & 0.833537 & 0.903400 & 0.846013 &
0.842079 & 0.870855 \\
6 & 0.805701 & 0.865777 & 0.738252 & 0.900031 & 0.684312 & 0.688316 &
0.835668 & 0.793280 & 0.658668 & 0.711921 & ... & 0.799660 & 0.815156 &
0.568228 & 0.839690 & 0.867198 & 0.800768 & 0.883415 & 0.815462 &
0.810789 & 0.844724 \\
7 & 0.765764 & 0.836917 & 0.687413 & 0.877998 & 0.625922 & 0.630461 &
0.801096 & 0.751245 & 0.597055 & 0.657358 & ... & 0.753979 & 0.772504 &
0.489965 & 0.801963 & 0.835308 & 0.755322 & 0.855066 & 0.772929 &
0.767277 & 0.808054 \\
8 & 0.730911 & 0.811318 & 0.643918 & 0.858284 & 0.576814 & 0.581753 &
0.770677 & 0.714702 & 0.545688 & 0.611083 & ... & 0.715067 & 0.735994 &
0.428794 & 0.769423 & 0.807597 & 0.716579 & 0.830306 & 0.736546 &
0.730066 & 0.776371 \\
9 & 0.711763 & 0.797083 & 0.620380 & 0.847249 & 0.550582 & 0.555709 &
0.753860 & 0.694673 & 0.518426 & 0.586210 & ... & 0.693836 & 0.716012 &
0.397504 & 0.751505 & 0.792252 & 0.695442 & 0.816544 & 0.716630 &
0.709718 & 0.758913 \\
10 & 0.658210 & 0.756579 & 0.555919 & 0.815554 & 0.480025 & 0.485554 &
0.706413 & 0.638904 & 0.445748 & 0.518694 & ... & 0.649566 & 0.674167 &
0.336864 & 0.713750 & 0.759693 & 0.651355 & 0.787230 & 0.674944 &
0.667160 & 0.722075 \\
11 & 0.642250 & 0.744299 & 0.537113 & 0.805857 & 0.459813 & 0.465430 &
0.692147 & 0.622350 & 0.425118 & 0.499183 & ... & 0.633729 & 0.659140 &
0.316646 & 0.700109 & 0.747857 & 0.635582 & 0.776529 & 0.659983 &
0.651895 & 0.708751 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cm\_subsection }\OperatorTok{=}\NormalTok{ np.linspace(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{120}\NormalTok{)}
\NormalTok{colors\_m }\OperatorTok{=}\NormalTok{ [cm.Reds(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ cm\_subsection]}
\NormalTok{colors }\OperatorTok{=}\NormalTok{ [cm.spring(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ cm\_subsection]}


\NormalTok{fig, axs }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{axs }\OperatorTok{=}\NormalTok{ axs.flatten()}
\NormalTok{cum\_haz\_frailty\_df.plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, color}\OperatorTok{=}\NormalTok{colors, alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{1}\NormalTok{])}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].plot(cum\_haz\_frailty\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{), color}\OperatorTok{=}\StringTok{"black"}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{axs[}\DecValTok{1}\NormalTok{].set\_title(}
    \StringTok{"Predicted Individual Cumulative Hazard }\CharTok{\textbackslash{}n}\StringTok{ \& Expected Cumulative Hazard"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}
\NormalTok{)}

\NormalTok{surv\_frailty\_df.plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, color}\OperatorTok{=}\NormalTok{colors\_m, alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, ax}\OperatorTok{=}\NormalTok{axs[}\DecValTok{0}\NormalTok{])}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].plot(surv\_frailty\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{), color}\OperatorTok{=}\StringTok{"black"}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].set\_title(}\StringTok{"Predicted Individual Survival Curves }\CharTok{\textbackslash{}n}\StringTok{  \& Expected Survival Curve"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{axs[}\DecValTok{0}\NormalTok{].annotate(}
    \SpecialStringTok{f"Expected Attrition by 6 months: }\SpecialCharTok{\{}\NormalTok{np}\SpecialCharTok{.}\BuiltInTok{round}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{surv\_frailty\_df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).iloc[}\DecValTok{6}\NormalTok{], }\DecValTok{3}\NormalTok{)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{    (}\DecValTok{2}\NormalTok{, }\FloatTok{0.5}\NormalTok{),}
\NormalTok{    fontsize}\OperatorTok{=}\DecValTok{12}\NormalTok{,}
\NormalTok{    fontweight}\OperatorTok{=}\StringTok{"bold"}\NormalTok{,}
\NormalTok{)}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-52-output-1.pdf}

\subsection{Plotting the effects of the Frailty
Terms}\label{plotting-the-effects-of-the-frailty-terms}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_individual\_all }\OperatorTok{=}\NormalTok{ frailty\_idata[}\StringTok{"posterior"}\NormalTok{][}\StringTok{"frailty"}\NormalTok{]}
\NormalTok{predicted\_all }\OperatorTok{=}\NormalTok{ beta\_individual\_all.mean((}\StringTok{"chain"}\NormalTok{, }\StringTok{"draw"}\NormalTok{))}
\NormalTok{predicted\_all }\OperatorTok{=}\NormalTok{ predicted\_all.sortby(predicted\_all, ascending}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{beta\_individual }\OperatorTok{=}\NormalTok{ beta\_individual\_all.sel(F}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(}\DecValTok{500}\NormalTok{))}
\NormalTok{predicted }\OperatorTok{=}\NormalTok{ beta\_individual.mean((}\StringTok{"chain"}\NormalTok{, }\StringTok{"draw"}\NormalTok{))}
\NormalTok{predicted }\OperatorTok{=}\NormalTok{ predicted.sortby(predicted, ascending}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{ci\_lb }\OperatorTok{=}\NormalTok{ beta\_individual.quantile(}\FloatTok{0.025}\NormalTok{, (}\StringTok{"chain"}\NormalTok{, }\StringTok{"draw"}\NormalTok{)).sortby(predicted)}
\NormalTok{ci\_ub }\OperatorTok{=}\NormalTok{ beta\_individual.quantile(}\FloatTok{0.975}\NormalTok{, (}\StringTok{"chain"}\NormalTok{, }\StringTok{"draw"}\NormalTok{)).sortby(predicted)}
\NormalTok{hdi }\OperatorTok{=}\NormalTok{ az.hdi(beta\_individual, hdi\_prob}\OperatorTok{=}\FloatTok{0.5}\NormalTok{).sortby(predicted)}
\NormalTok{hdi2 }\OperatorTok{=}\NormalTok{ az.hdi(beta\_individual, hdi\_prob}\OperatorTok{=}\FloatTok{0.8}\NormalTok{).sortby(predicted)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cm\_subsection }\OperatorTok{=}\NormalTok{ np.linspace(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{500}\NormalTok{)}
\NormalTok{colors }\OperatorTok{=}\NormalTok{ [cm.cool(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ cm\_subsection]}

\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\NormalTok{gs }\OperatorTok{=}\NormalTok{ fig.add\_gridspec(}
    \DecValTok{2}\NormalTok{,}
    \DecValTok{2}\NormalTok{,}
\NormalTok{    height\_ratios}\OperatorTok{=}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{7}\NormalTok{),}
\NormalTok{    left}\OperatorTok{=}\FloatTok{0.1}\NormalTok{,}
\NormalTok{    right}\OperatorTok{=}\FloatTok{0.9}\NormalTok{,}
\NormalTok{    bottom}\OperatorTok{=}\FloatTok{0.1}\NormalTok{,}
\NormalTok{    top}\OperatorTok{=}\FloatTok{0.9}\NormalTok{,}
\NormalTok{    wspace}\OperatorTok{=}\FloatTok{0.05}\NormalTok{,}
\NormalTok{    hspace}\OperatorTok{=}\FloatTok{0.05}\NormalTok{,}
\NormalTok{)}

\CommentTok{\# Create the Axes.}
\NormalTok{ax }\OperatorTok{=}\NormalTok{ fig.add\_subplot(gs[}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{])}
\NormalTok{ax.set\_yticklabels([])}
\NormalTok{ax\_histx }\OperatorTok{=}\NormalTok{ fig.add\_subplot(gs[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{], sharex}\OperatorTok{=}\NormalTok{ax)}
\NormalTok{ax\_histx.set\_title(}\StringTok{"Expected Frailty Terms per Individual Risk Profile"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{ax\_histx.hist(predicted\_all, bins}\OperatorTok{=}\DecValTok{30}\NormalTok{, color}\OperatorTok{=}\StringTok{"slateblue"}\NormalTok{)}
\NormalTok{ax\_histx.set\_yticklabels([])}
\NormalTok{ax\_histx.tick\_params(labelsize}\OperatorTok{=}\DecValTok{8}\NormalTok{)}
\NormalTok{ax.set\_ylabel(}\StringTok{"Individual Frailty Terms"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{18}\NormalTok{)}
\NormalTok{ax.tick\_params(labelsize}\OperatorTok{=}\DecValTok{8}\NormalTok{)}
\NormalTok{ax.hlines(}
    \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(predicted)),}
\NormalTok{    hdi.sel(hdi}\OperatorTok{=}\StringTok{"lower"}\NormalTok{).to\_array(),}
\NormalTok{    hdi.sel(hdi}\OperatorTok{=}\StringTok{"higher"}\NormalTok{).to\_array(),}
\NormalTok{    color}\OperatorTok{=}\NormalTok{colors,}
\NormalTok{    label}\OperatorTok{=}\StringTok{"50\% HDI"}\NormalTok{,}
\NormalTok{    linewidth}\OperatorTok{=}\FloatTok{0.8}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.hlines(}
    \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(predicted)),}
\NormalTok{    hdi2.sel(hdi}\OperatorTok{=}\StringTok{"lower"}\NormalTok{).to\_array(),}
\NormalTok{    hdi2.sel(hdi}\OperatorTok{=}\StringTok{"higher"}\NormalTok{).to\_array(),}
\NormalTok{    color}\OperatorTok{=}\StringTok{"green"}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.2}\NormalTok{,}
\NormalTok{    label}\OperatorTok{=}\StringTok{"80\% HDI"}\NormalTok{,}
\NormalTok{    linewidth}\OperatorTok{=}\FloatTok{0.8}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax.set\_xlabel(}\StringTok{"Multiplicative Effect of Individual Frailty"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{18}\NormalTok{)}
\NormalTok{ax.legend()}
\NormalTok{ax.fill\_betweenx(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(predicted)), }\FloatTok{0.95}\NormalTok{, }\FloatTok{1.0}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.4}\NormalTok{, color}\OperatorTok{=}\StringTok{"grey"}\NormalTok{)}

\NormalTok{ax1 }\OperatorTok{=}\NormalTok{ fig.add\_subplot(gs[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{])}
\NormalTok{f\_index }\OperatorTok{=}\NormalTok{ retention\_df[retention\_df[}\StringTok{"gender"}\NormalTok{] }\OperatorTok{==} \StringTok{"F"}\NormalTok{].index}
\NormalTok{index }\OperatorTok{=}\NormalTok{ retention\_df.index}
\NormalTok{surv\_frailty\_df[}\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(f\_index)))].plot(ax}\OperatorTok{=}\NormalTok{ax1, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, color}\OperatorTok{=}\StringTok{"red"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
\NormalTok{surv\_frailty\_df[}\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(f\_index), }\BuiltInTok{len}\NormalTok{(index), }\DecValTok{1}\NormalTok{))].plot(}
\NormalTok{    ax}\OperatorTok{=}\NormalTok{ax1, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, color}\OperatorTok{=}\StringTok{"royalblue"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.1}
\NormalTok{)}
\NormalTok{ax1\_hist }\OperatorTok{=}\NormalTok{ fig.add\_subplot(gs[}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{])}
\NormalTok{f\_index }\OperatorTok{=}\NormalTok{ retention\_df[retention\_df[}\StringTok{"gender"}\NormalTok{] }\OperatorTok{==} \StringTok{"F"}\NormalTok{].index}
\NormalTok{ax1\_hist.hist(}
\NormalTok{    (}\DecValTok{1} \OperatorTok{{-}}\NormalTok{ surv\_frailty\_df[}\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(f\_index), }\BuiltInTok{len}\NormalTok{(index), }\DecValTok{1}\NormalTok{))].iloc[}\DecValTok{6}\NormalTok{]),}
\NormalTok{    bins}\OperatorTok{=}\DecValTok{30}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\StringTok{"royalblue"}\NormalTok{,}
\NormalTok{    ec}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.8}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax1\_hist.hist(}
\NormalTok{    (}\DecValTok{1} \OperatorTok{{-}}\NormalTok{ surv\_frailty\_df[}\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(f\_index)))].iloc[}\DecValTok{6}\NormalTok{]),}
\NormalTok{    bins}\OperatorTok{=}\DecValTok{30}\NormalTok{,}
\NormalTok{    color}\OperatorTok{=}\StringTok{"red"}\NormalTok{,}
\NormalTok{    ec}\OperatorTok{=}\StringTok{"black"}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.8}\NormalTok{,}
\NormalTok{)}
\NormalTok{ax1.set\_xlabel(}\StringTok{"Time"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{18}\NormalTok{)}
\NormalTok{ax1\_hist.set\_title(}
    \StringTok{"Predicted Distribution of Attrition }\CharTok{\textbackslash{}n}\StringTok{ by 6 Months across all risk profiles"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{20}
\NormalTok{)}
\NormalTok{ax1.set\_ylabel(}\StringTok{"Survival Function"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{18}\NormalTok{)}
\NormalTok{ax.scatter(predicted, }\BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(predicted)), color}\OperatorTok{=}\StringTok{"black"}\NormalTok{, ec}\OperatorTok{=}\StringTok{"black"}\NormalTok{, s}\OperatorTok{=}\DecValTok{30}\NormalTok{)}

\CommentTok{\# Create a manual legend without Line2D}
\NormalTok{ax1.legend([}\StringTok{"Female"}\NormalTok{, }\StringTok{"Male"}\NormalTok{], loc}\OperatorTok{=}\StringTok{"upper right"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Frailty_and_Survival_Regression_in_Stan_files/figure-pdf/cell-54-output-1.pdf}



\end{document}
